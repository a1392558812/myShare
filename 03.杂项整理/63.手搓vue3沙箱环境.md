## æ‰‹æ“vue3æ²™ç®±ç¯å¢ƒ

> ç ä¸Šæ˜é‡‘ä»Šå¹´(2024)6æœˆä»½å¼€å¤´æ²¡å‡ å¤©å°±æŒ‚äº†ï¼Œåé¦ˆäº†2ä¸ªç¤¼æ‹œï¼Œç›´åˆ°ä»Šå¤©(2024-06-20 09:42)éƒ½æ²¡æœ‰äººä¿®ã€‚
ä»€ä¹ˆçº¿ä¸Šbugï¼Œåªè¦ä½ çš„åé¦ˆæˆ‘ä¸å¬ï¼Œé‚£å®ƒå°±ä¸æ˜¯bugã€‚
è‡ªå·±æ‰‹æ“ä¸€ä¸ªç®€æ˜“æ¼”ç¤ºä»£ç æ²™ç®±ç¯å¢ƒ

ä¸€ä¸ªç®€å•çš„æ²™ç®±ç¯å¢ƒï¼Œæš‚æœªæ”¯æŒ`<script setup>`è¯­æ³•

### å®šä¹‰ç»„ä»¶

```html

<template>
    <div>
        <div class="toggle-btn-wrap">
            <div class="toggle-btn" :style="editMode === 'preview' ? { background: 'pink' } : {}" @click="editMode = 'preview'">previewæ¨¡å¼</div>
            <div class="toggle-btn" :style="editMode === 'edit' ? { background: 'pink' } : {}" @click="editMode = 'edit'">editæ¨¡å¼</div>
            <div v-if="editMode === 'edit'" class="toggle-btn">
                <label style="margin-right: 10px">ç¼–è¾‘å™¨å®½åº¦: {{ contentWrapWidth }}%</label>
                <input style="width: 40px" type="number" :value="contentWrapWidth" @input="onInput" />
            </div>
        </div>
        <div class="iframe-wrap">
            <div v-if="editMode === 'edit'" class="content-wrap" :style="{ width: `${contentWrapWidth}%` }">
                <div class="textarea-warp">
                    <div class="textarea-title">template</div>
                    <textarea class="textarea-item" v-model="templateValueComputed" />
                </div>
                <div class="textarea-warp">
                    <div class="textarea-title">script</div>
                    <textarea class="textarea-item" v-model="scriptValueComputed" />
                </div>
                <div class="textarea-warp">
                    <div class="textarea-title">css</div>
                    <textarea class="textarea-item" v-model="cssValueComputed" />
                </div>
                <div class="textarea-warp">
                    <div class="textarea-title">imports</div>
                    <textarea class="textarea-item" v-model="importsComputed" />
                </div>
            </div>
            <iframe :style="{ flex: 1 }" class="iframe-item" ref="iframeRef"></iframe>
        </div>
    </div>
</template>
<script setup>
import { ref, computed, watch, defineProps, defineEmits, nextTick, onUnmounted } from 'vue'

const props = defineProps({
  mode: {
    type: String,
    default: 'edit' // preview edit
  },
  templateValue: {
    type: String,
    default: '<div></div>'
  },
  cssValue: {
    type: String,
    default: ''
  },
  scriptValue: {
    type: String,
    default: 'export default { setup() {} }'
  },
  imports: {
    type: Object,
    default: () => ({
      vue: 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'
    })
  },
  beforeAppMount: {
    type: String,
    default: ';console.log("ğŸ® --- beforeAppMount");'
  },
  afterAppMount: {
    type: String,
    default: ';console.log("ğŸ® --- afterAppMount", app);'
  }
})

const emit = defineEmits(['update:templateValue', 'update:scriptValue', 'update:cssValue', 'update:imports'])

const editMode = ref('')
const iframeRef = ref(null)
const contentWrapWidth = ref(50)

let blob = ''
let iframeRefBlob = ''

const templateValueComputed = computed({
  get () {
    return props.templateValue
  },
  set (val) {
    emit('update:templateValue', val)
  }
})
const scriptValueComputed = computed({
  get () {
    return props.scriptValue
  },
  set (val) {
    emit('update:scriptValue', val)
  }
})
const cssValueComputed = computed({
  get () {
    return props.cssValue
  },
  set (val) {
    emit('update:cssValue', val)
  }
})
const importsComputed = computed({
  get () {
    return JSON.stringify(props.imports)
  },
  set (val) {
    emit('update:imports', JSON.parse(val))
  }
})

const onInput = (e) => {
  const val = +e.target.value
  if (!val) {
    contentWrapWidth.value = 0
    return
  }
  if (val > 100) {
    contentWrapWidth.value = 100
    return
  }
  if (val < 0) {
    contentWrapWidth.value = 0
    return
  }
  contentWrapWidth.value = val
}

const destroyBlob = () => {
  URL.revokeObjectURL(blob)
  URL.revokeObjectURL(iframeRefBlob)
  blob = ''
  iframeRefBlob = ''
}

watch(
  () => [
    props.templateValue,
    props.scriptValue,
    props.cssValue,
    props.imports,
    props.beforeAppMount,
    props.afterAppMount
  ],
  (newList, oldList) => {
    nextTick().then(() => {
      destroyBlob()
      blob = URL.createObjectURL(new Blob([props.scriptValue], { type: 'text/javascript;charset=UTF-8' }))
      iframeRefBlob = URL.createObjectURL(new Blob(
        [
                    `<style>
html, body{ padding: 0; margin: 0 }
${props.cssValue}
</style>
<script type="importmap">
  {
    "imports": ` + JSON.stringify(props.imports) + `
  }
</` + `script>

<div id="app"></div>

<script type="module">
  import { createApp } from 'vue'
  import option from '${blob}'

  ;${props.beforeAppMount};

  ;const app = createApp({
    template: '${props.templateValue.replace(/\n/g, '')}',
    ...option
  })

  ;${props.afterAppMount};

  ;app.mount('#app')
<` + '/script>'
        ],
        { type: 'text/html;charset=UTF-8' }
      ))

      console.log('watch-data', { newList, oldList, blob, iframeRefBlob })

      iframeRef.value.src = iframeRefBlob
    })
  },
  { immediate: true }
)

watch(() => props.mode, (newV, oldV) => {
  if (newV !== oldV) {
    editMode.value = newV
  }
}, { immediate: true })

onUnmounted(() => {
  destroyBlob()
})

</script>
<style scoped lang="scss">
    .toggle-btn-wrap {
      display: flex;
      margin-bottom: 10px;
      .toggle-btn {
        font-size: 14px;
        line-height: 1;
        padding: 0 10px;
        height: 30px;
        border: 1px solid #000;
        cursor: pointer;
        margin-right: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    }

    .iframe-wrap {
      width: 100%;
      display: flex;
      .content-wrap {
        display: flex;
        flex-direction: column;
        margin-right: 20px;
        border: 1px solid #000;
        .textarea-warp {
          width: 100%;
          border-bottom: none;
          .textarea-title {
            width: 100%;
            padding: 10px 20px;
            font-size: 16px;
            line-height: 1;
            box-sizing: border-box;
            border: none;
            border-bottom: 1px solid #000;
          }
          .textarea-item {
            padding: 10px;
            display: block;
            resize: none;
            width: 100%;
            height: 350px;
            overflow: auto;
            flex-shrink: 0;
            box-sizing: border-box;
            border: none;
            border-bottom: 1px solid #000;
            &:focus-visible {
              outline: none;
              border-bottom: 1px solid #000;
            }
          }
        }
      }
      .iframe-item {
        flex-shrink: 0;
        min-width: 0;
        padding: 0;
        margin: 0;
        display: block;
        border-width: 1px;
        flex-shrink: 0;
        box-sizing: border-box;
        border: 1px solid #000;
      }
    }
</style>
```

### ä½¿ç”¨ç»„ä»¶

```html
<template>
    <div class="playground2 overflow-auto">
        <codeEdit mode="edit" v-model:imports="imports" v-model:templateValue="templateValue" v-model:cssValue="cssValue" v-model:scriptValue="scriptValue"></codeEdit>
    </div>
</template>
<script setup>
import { ref } from 'vue'
import { baseUrlFun } from '@/common/methods.js'
import codeEdit from './components/playground2-plane/index.vue'

const baseUrl = baseUrlFun()

const imports = ref({
  vue: 'https://unpkg.com/vue@3/dist/vue.esm-browser.js',
  "vue-demi": "https://unpkg.com/vue-demi/lib/index.mjs",
  '@vueuse/core': 'https://unpkg.com/@vueuse/core@10.1.0/index.mjs',
  "@vueuse/shared": "https://unpkg.com/@vueuse/shared@10.1.0/index.mjs",
})
const templateValue = ref(`<div>
    <div class="test-box" @click="handleClick">ä¸€ä¸ªç®€å•çš„æ²™ç®±ç¯å¢ƒ--->num: {{ num }}</div>
    <div ref="target" style="width: 200px; height: 200px; border: 1px solid #000">
        <div>x: {{x}}</div>
        <div>y: {{y}}</div>
        <div>isOutside: {{isOutside}}</div>
    </div>
</div>`)
const cssValue = ref(`.test-box {
  border: 1px solid #eee;
  padding: 10px 20px;
  background: pink;
  border-radius: 10px;
  cursor: pointer;
}`)

const scriptValue = ref(`import { ref } from 'vue'
import { useMouseInElement } from '@vueuse/core'
export default {
  setup() {
    const num = ref(1)
    const target = ref(null)
    const { x, y, isOutside } = useMouseInElement(target)
    const handleClick = () => {
      console.log('handleClick')
      num.value = num.value + 1
    }
    return {
      handleClick,
      num,
      target,
      x,
      y,
      isOutside
    }
  }
}`)
</script>
<style scoped>
.playground2 {
    width: 100vw;
    height: 100vh;
}
</style>
```