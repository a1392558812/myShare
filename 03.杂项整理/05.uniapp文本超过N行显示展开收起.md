# uniapp 文本超过 N 行显示展开收起

> 组件 1: 运算简单和渲染占用少，但有时候省略号会遮不住文本
> 组件 2: 省略号位置是计算出来的，不会遮住文本，但运算和渲染占用会大一些

// symbolStyle collapseStyle expandStyle textStyle 这几个 style 自定义时最好只设置 fontSize color lineHeight 等涉及 font 的 css 属性，不要添加 padding margin 等可能改变文本高度或者改变布局的属性，

## 组件 1

```html
<template>
  <view
    :id="textContentId"
    class="text-content"
    :style="[showText ? {} : { '-webkit-line-clamp': n }, textStyle]"
  >
    <text>{{ text }}</text>

    <text
      v-if="isEllipsis && showText"
      :style="[textStyle, collapseStyle]"
      @click="shiftText"
    >
      {{ collapseText }}
    </text>

    <text
      v-if="isEllipsis && !showText"
      class="btn-text"
      :style="textStyle"
      @click="shiftText"
    >
      <text :style="symbolStyle"> {{ symbolText }} </text>
      <text :style="expandStyle"> {{ expandText }} </text>
    </text>

    <text
      :id="textPlaceholderHeightId"
      :style="[textStyle, { color: 'transparent' }]"
      class="text-placeholder__height"
    >
      占位
    </text>
  </view>
</template>

<script setup lang="ts">
  import { getCurrentInstance, nextTick, onMounted, ref, watch } from "vue";

  /**
   * @name TextEllipsis
   * @description 文本超出N行显示（...全文）
   * @param {string} text 文本
   * @param {number} n 文本超出n行显示省略
   */

  export interface EllipsisPropsType {
    text?: string;
    n?: number;
    collapseText?: string;
    expandText?: string;
    symbolText?: string;
    textStyle?: AnyStyleType;
    symbolStyle?: AnyStyleType;
    collapseStyle?: AnyStyleType;
    expandStyle?: AnyStyleType;
  }

  const props = withDefaults(defineProps<EllipsisPropsType>(), {
    text: "",
    n: 1,
    collapseText: "收起",
    expandText: "展开",
    symbolText: "...",
    textStyle: () => ({
      fontSize: "30rpx",
      lineHeight: 1.3,
    }),
    symbolStyle: () => ({
      color: "red",
    }),
    collapseStyle: () => ({
      color: "orange",
    }),
    expandStyle: () => ({
      color: "green",
    }),
  });

  const getUuid = () => {
    const s4 = () =>
      Math.floor((1 + Math.random()) * 0x10000)
        .toString(16)
        .substring(1);
    return s4() + s4() + s4() + s4() + s4() + s4() + s4() + s4();
  };

  const uuid = getUuid();

  const textContentId = `textContentId${uuid}`;
  const textPlaceholderHeightId = `textPlaceholderHeightId${uuid}`;

  const showText = ref(true);
  const isEllipsis = ref(false);
  const { proxy } = getCurrentInstance() as any;

  const shiftText = () => {
    showText.value = !showText.value;
  };

  const initGetRect = () => {
    showText.value = true;
    isEllipsis.value = false;
    const query = uni.createSelectorQuery().in(proxy);
    let textHeight = 0;
    // 计算占位字体高度

    query
      .select(`#${textPlaceholderHeightId}`)
      .fields(
        {
          computedStyle: ["letter-spacing"],
        },
        (res) => {
          console.log("initGetRect", res);
        }
      )
      .exec();

    query
      .select(`#${textPlaceholderHeightId}`)
      .boundingClientRect((data) => {
        textHeight = (data as UniApp.NodeInfo).height || 0;
      })
      .exec();

    query
      .select(`#${textContentId}`)
      .boundingClientRect((data) => {
        const height = (data as UniApp.NodeInfo).height || 0;
        if (height - 0.1 > textHeight * props.n) {
          // 计算误差小于0.1
          isEllipsis.value = true;
          showText.value = false;
        }
      })
      .exec();
  };

  watch(
    props,
    () => {
      nextTick(() => {
        initGetRect();
      });
    },
    {
      immediate: true,
    }
  );
</script>

<style lang="scss" scoped>
  .text-content {
    position: relative;
    text-overflow: ellipsis;
    overflow: hidden;
    display: -webkit-box;
    -webkit-box-orient: vertical;

    .text-placeholder__height {
      position: absolute;
      top: 0;
      left: 0;
    }

    .btn-text {
      position: absolute;
      right: 0;
      bottom: 0;
      z-index: 2;
      padding-right: 0.25em;
      display: inline;
      background-color: #fff;
    }
  }
</style>
```

## 组件 2

```html
<template>
  <view
    :id="textContentId"
    class="text-content"
    :style="[showText ? {} : { 'line-clamp': n, '-webkit-line-clamp': n }, textStyle]"
  >
    <text>{{ showText ? text : targetText }}</text>
    <template v-if="isEllipsis">
      <text
        v-if="showText"
        :style="[{ whiteSpace: 'nowrap' }, textStyle, collapseStyle]"
        @click="shiftText"
      >
        {{ collapseText }}
      </text>

      <text v-else :style="[{ whiteSpace: 'nowrap' }, textStyle]">
        <text :style="[{ whiteSpace: 'nowrap' }, textStyle, symbolStyle]">
          {{ symbolText }}
        </text>
        <text
          :style="[{ whiteSpace: 'nowrap' }, textStyle, expandStyle]"
          @click="shiftText"
        >
          {{ expandText }}
        </text>
      </text>
    </template>

    <view
      :id="textContentCopyId"
      :style="[textContentCopyStyle, textStyle]"
      class="text-content-copy"
    >
      <text>{{ targetCopyText }}</text>
      <text :style="[{ whiteSpace: 'nowrap' }, textStyle]">
        <text :style="[{ whiteSpace: 'nowrap' }, textStyle, symbolStyle]">
          {{ symbolText }}
        </text>
        <text :style="[{ whiteSpace: 'nowrap' }, textStyle, expandStyle]">
          {{ expandText }}
        </text>
      </text>
    </view>

    <text
      :id="textPlaceholderHeightId"
      :style="[textStyle, { color: 'transparent' }]"
      class="text-placeholder__height"
    >
      占位
    </text>
  </view>
</template>

<script setup lang="ts">
  import { getCurrentInstance, nextTick, onMounted, ref, watch } from "vue";

  /**
   * @name TextEllipsis
   * @description 文本超出N行显示（...全文）
   *
   * @param {string} text 文本
   * @param {number} n 文本超出n行显示省略号
   *
   * @param {string} collapseText 收起文本
   * @param {string} expandText 展开文本
   * @param {string} symbolText 省略号文本
   *
   *  (注：collapseText的长度不要超过 expandText+symbolText长度，不然会有点奇妙小bug)
   *
   * @param {AnyStyleType} textStyle 文本样式
   * @param {AnyStyleType} symbolStyle 省略号样式
   * @param {AnyStyleType} collapseStyle 收起文本样式
   * @param {AnyStyleType} expandStyle 展开文本样式
   */

  export interface EllipsisPropsType {
    text?: string;
    n?: number;
    collapseText?: string;
    expandText?: string;
    textStyle?: AnyStyleType;
    symbolText?: string;
    symbolStyle?: AnyStyleType;
    collapseStyle?: AnyStyleType;
    expandStyle?: AnyStyleType;
  }

  const props = withDefaults(defineProps<EllipsisPropsType>(), {
    text: "",
    n: 2,
    collapseText: "收起",
    expandText: "展开",
    symbolText: "...",
    textStyle: () => ({
      fontSize: "30rpx",
      lineHeight: 1.3,
    }),
    symbolStyle: () => ({
      color: "red",
    }),
    collapseStyle: () => ({
      color: "orange",
    }),
    expandStyle: () => ({
      color: "green",
    }),
  });

  const getUuid = () => {
    const s4 = () =>
      Math.floor((1 + Math.random()) * 0x10000)
        .toString(16)
        .substring(1);
    return s4() + s4() + s4() + s4() + s4() + s4() + s4() + s4();
  };

  const uuid = getUuid();

  const textContentCopyStyle = ref<AnyStyleType>({});

  const textContentId = `textContentId${uuid}`;
  const textContentCopyId = `textContentCopyId${uuid}`;
  const textPlaceholderHeightId = `textPlaceholderHeightId${uuid}`;

  const showText = ref(false); // 是否展开
  const targetText = ref(""); // 目标文本
  const targetCopyText = ref(""); // 目标文本

  const isEllipsis = ref(false); // 是否需要显示省略号和展开/收起按钮
  const { proxy } = getCurrentInstance() as any;

  const shiftText = () => {
    showText.value = !showText.value;
  };

  const getSize = () => {
    const query = uni.createSelectorQuery().in(proxy);
    let textHeight = 0;
    let contentWidth = 0;

    query
      .select(`#${textPlaceholderHeightId}`)
      .boundingClientRect((data) => {
        textHeight = (data as UniApp.NodeInfo).height || 0;
      })
      .exec();

    query
      .select(`#${textContentId}`)
      .boundingClientRect((data) => {
        contentWidth = (data as UniApp.NodeInfo).width || 0;
      })
      .exec();

    return {
      textHeight,
      contentWidth,
    };
  };

  const initGetRect = (resultText: string, textHeight: number) => {
    const query = uni.createSelectorQuery().in(proxy);
    targetText.value = "";

    // 目标高度：n行文本的高度
    const targetHeight = textHeight * props.n;

    // 如果文本为空，直接返回
    if (!resultText) {
      targetText.value = "";
      isEllipsis.value = false;
      return;
    }

    const checkHeight = (mid: number, text: string) => {
      return new Promise<boolean>((resolve) => {
        targetCopyText.value = text.substring(0, mid);

        nextTick(() => {
          query
            .select(`#${textContentCopyId}`)
            .boundingClientRect((data) => {
              const currentHeight = (data as UniApp.NodeInfo).height || 0;
              resolve(currentHeight <= targetHeight);
            })
            .exec();
        });
      });
    };

    const binarySearchText = (text: string): Promise<number> => {
      return new Promise((resolve) => {
        let left = 0;
        let right = text.length;
        let result = 0;
        const search = async () => {
          if (left > right) {
            resolve(result); // 找到最大的满足条件的文本长度
            return;
          }

          const mid = Math.floor((left + right) / 2);
          const isWithinHeight = await checkHeight(mid, text);

          if (isWithinHeight) {
            // 如果当前长度满足高度要求，尝试更长的文本
            result = mid;
            left = mid + 1;
          } else {
            // 如果当前长度超过高度要求，尝试更短的文本
            right = mid - 1;
          }
          search();
        };
        search();
      });
    };

    binarySearchText(resultText).then((result) => {
      targetText.value = resultText.substring(0, result);
      isEllipsis.value = result < resultText.length;
    });
  };

  watch(
    props,
    () => {
      console.log("props.text", props.text);
      nextTick(() => {
        const { textHeight, contentWidth } = getSize();
        textContentCopyStyle.value.width = `${contentWidth}px`;

        initGetRect(props.text, textHeight);
      });
    },
    {
      immediate: true,
    }
  );
</script>

<style lang="scss" scoped>
  .text-content {
    position: relative;
    overflow: hidden;

    .text-placeholder__height {
      position: absolute;
      top: 0;
      left: 0;
    }

    .text-content-copy {
      position: absolute;
      top: -99999px;
      left: -99999px;
      z-index: -1;
      visibility: hidden;
      display: inline;
      background-color: #fff;
    }
  }
</style>
```
