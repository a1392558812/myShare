# Streamable-HTTP 与 SSE 流式推送

## 原理简述

### 1. Streamable-HTTP

本质是利用 HTTP 响应的可读流（ReadableStream），前端可边接收边处理数据。

### 2. SSE

基于 HTTP 协议，服务器以 `text/event-stream` 格式持续推送事件，浏览器原生支持 `EventSource` API。

---

## 代码示例

### 1. Streamable-HTTP（以 Fetch + ReadableStream 为例）

```javascript
// 后台node+express
const express = require("express");
const app = express();
const server = app.listen(8080);
app.get("/api/stream", (req, res) => {
  res.setHeader("Content-Type", "text/plain");
  res.setHeader("Transfer-Encoding", "chunked");
  res.write("Hello, ");
  setTimeout(() => {
    res.write("World!");
    res.end();
  }, 2000);
});
```

```js
// 假设后端返回大文本流
fetch("/api/stream").then((response) => {
  const reader = response.body.getReader();
  const decoder = new TextDecoder();
  let received = "";
  function read() {
    return reader.read().then(({ done, value }) => {
      if (done) {
        console.log("Stream finished");
        return;
      }
      received += decoder.decode(value, { stream: true });
      console.log(received);
      return read();
    });
  }
  return read();
});
```

### 2. SSE（Server-Sent Events）

```js
// 前端直接用 EventSource 监听服务器推送
const es = new EventSource("/api/sse");
es.onmessage = (event) => {
  console.log("收到消息:", event.data);
  // 可实时渲染到页面
};
es.onerror = (err) => {
  console.error("SSE 连接出错", err);
};
```

### Streamable-HTTP 优缺点

#### 优点：

- 支持大数据量流式传输，适合 AI 输出、视频、日志等边下边用场景。
- 可传输任意格式（文本、二进制等），灵活性高。
- 基于标准 HTTP，易于与现有后端集成。
- 前端可用 Fetch + ReadableStream 实现，支持流式处理。

#### 缺点：

- 仅支持单次请求响应，不能持续推送新事件。
- 断线重连、进度管理等需手动实现。
- 兼容性依赖新版本浏览器，老旧浏览器支持较差。
- 仅适合单向大流量数据，不适合频繁小消息推送。

### SSE 优缺点

#### 优点：

- 服务器可持续推送事件，适合实时消息、进度、通知等场景。
- 浏览器原生支持 EventSource，API 简单易用。
- 自动断线重连，开发体验好。
- 轻量级，适合单向实时通信。

#### 缺点：

- 仅支持文本格式（event-stream），不适合二进制数据。
- 仅支持服务器到客户端单向推送，不能双向通信。
- 受限于 HTTP/1.x，连接数有限（尤其在多标签页下）。
- IE 不支持，部分老旧浏览器兼容性差。

## 总结与选型建议

### Streamable-HTTP

- **大文件/大数据下载**：如视频、日志、报表等需要边下边用的场景。
- **AI/大模型流式输出**：如 ChatGPT、AI 绘画等，后端生成内容逐步推送到前端。
- **实时日志/监控**：后端持续输出日志，前端实时展示。

### SSE（Server-Sent Events）

- **实时消息推送**：如系统通知、进度更新、弹幕等。
- **数据流监控**：如股票行情、传感器数据等实时刷新。
- **轻量级实时通信**：无需双向通信，仅需服务器单向推送。
