# plus 封装

```typescript
import { checkRequestPermission } from "04.杂项整理/16.uniapp的plus权限申请.md";

export const plusCameraMethods = (data?: {
  options?: PlusCameraCameraOptions;
  type?: "image" | "video";
}): Promise<string> => {
  return new Promise((resolve, reject) => {
    return checkRequestPermission("Camera")
      .then((flag) => {
        if (!flag) {
          return reject(false);
        }
        const camera = plus.camera.getCamera();
        const cameraType = data && data.type === "video" ? "video" : "image";
        let cameraMethod:
          | PlusCameraCamera["captureImage"]
          | PlusCameraCamera["startVideoCapture"];
        let cameraOptions: PlusCameraCameraOptions;
        const propsOptions = data && data.options ? data.options : {};

        if (cameraType === "image") {
          cameraMethod = camera.captureImage;
          cameraOptions = Object.assign({ format: "jpg" }, propsOptions);
        } else {
          cameraMethod = camera.startVideoCapture;
          cameraOptions = Object.assign(
            {
              format: "mp4",
              videoMaximumDuration: propsOptions.videoMaximumDuration || 15,
            },
            propsOptions,
          );
        }

        cameraMethod(
          (capturedFile) => {
            plus.io.resolveLocalFileSystemURL(
              capturedFile,
              (entry) => {
                const fullPath = entry.toLocalURL();
                const absolutePath = entry.fullPath;
                console.log("getCamera:", {
                  capturedFile,
                  fullPath,
                  absolutePath,
                });
                if (absolutePath) {
                  return resolve(absolutePath);
                }
                uni.showToast({
                  title: "获取拍摄失败",
                  icon: "none",
                });
                return reject("获取拍摄结果失败");
              },
              (err) => {
                uni.showToast({
                  title: err.message || "获取拍摄图片失败",
                  icon: "none",
                });
                return reject(err);
              },
            );
          },
          (err) => {
            console.log(
              "相机拍摄失败",
              err === "null",
              err,
              JSON.stringify(err),
            );
            if (
              err === "null" ||
              ["用户取消", "User cancelled"].includes(err.message) ||
              [11].includes(err.code)
            ) {
              return reject(err);
            }
            uni.showToast({
              title: err.message || "相机拍摄失败",
              icon: "none",
            });
            return reject(err);
          },
          cameraOptions,
        );
      })
      .catch((err) => {
        return reject(err);
      });
  });
};

export const plusGalleryPick = (
  options: PlusGalleryGalleryOptions,
): Promise<string> => {
  return new Promise((resolve, reject) => {
    return checkRequestPermission("CameraPhotos")
      .then((flag) => {
        if (!flag) {
          return reject(false);
        }
        plus.gallery.pick(
          (res) => {
            return resolve(res);
          },
          (err) => {
            console.log("文件选择失败", JSON.stringify(err));
            if (
              ["用户取消", "User cancelled"].includes(err.message) ||
              [-2].includes(err.code)
            ) {
              return reject(err);
            }
            uni.showToast({
              title: err.message || "文件选择失败",
              icon: "none",
            });
            return reject(err);
          },
          options,
        );
      })
      .catch((err) => {
        return reject(err);
      });
  });
};

export const plusPickOrCapture = (data: {
  captureOptions?: PlusCameraCameraOptions;
  galleryOptions: PlusGalleryGalleryOptions;
}): Promise<string> => {
  return new Promise((resolve, reject) => {
    let itemList: string[];
    const takePhoto = "拍照";
    const videotape = "拍摄";
    const pickFromGallery = "系统相册选择";

    if (!data.galleryOptions.filter) {
      itemList = [takePhoto, pickFromGallery];
    } else {
      if (data.galleryOptions.filter === "image") {
        itemList = [takePhoto, pickFromGallery];
      } else if (data.galleryOptions.filter === "video") {
        itemList = [videotape, pickFromGallery];
      } else if (data.galleryOptions.filter === "none") {
        itemList = [takePhoto, videotape, pickFromGallery];
      } else {
        return reject("请选择正确的类型");
      }
    }

    uni.showActionSheet({
      itemList,
      success: (res) => {
        let selectPromise: Promise<string>;

        if ([takePhoto].includes(itemList[res.tapIndex])) {
          selectPromise = plusCameraMethods({
            type: "image",
            options: data.captureOptions,
          });
        } else if ([videotape].includes(itemList[res.tapIndex])) {
          selectPromise = plusCameraMethods({
            type: "video",
            options: data.captureOptions,
          });
        } else if ([pickFromGallery].includes(itemList[res.tapIndex])) {
          selectPromise = plusGalleryPick(data.galleryOptions);
        } else {
          return reject("不支持该操作");
        }

        selectPromise
          .then((res) => {
            return resolve(res);
          })
          .catch((err) => {
            return reject(err);
          });
      },
      fail: (err) => {
        return reject(err);
      },
    });
  });
};

export const plusGallerySave = (
  path: string,
): Promise<PlusGalleryGallerySaveEvent> => {
  return new Promise((resolve, reject) => {
    return checkRequestPermission("Photos")
      .then((flag) => {
        if (!flag) {
          return reject(false);
        }
        return plus.gallery.save(
          path,
          (res) => {
            return resolve(res);
          },
          (err) => {
            console.log("保存图片失败", JSON.stringify(err));
            uni.showToast({
              title: err.message || "保存图片失败",
              icon: "none",
            });
            return reject(err);
          },
        );
      })
      .catch((err) => {
        return reject(err);
      });
  });
};

export const saveBase64Pic = (data: {
  base64Str: string;
  fileName?: string;
  suffix?: string;
  quality?: number;
  width?: string;
  height?: string;
  compressedWidth?: number;
  compressedHeight?: number;
}) => {
  if (!plus.nativeObj.Bitmap) {
    return uni.showToast({
      title: "当前环境不支持保存图片",
      icon: "none",
    });
  }
  const bitmap = new plus.nativeObj.Bitmap();
  bitmap.loadBase64Data(
    data.base64Str,
    () => {
      bitmap.save(
        `_doc/${data.fileName || new Date().getTime()}.${data.suffix || "png"}`,
        {
          overwrite: true,
          quality: data.quality || 100,
        },
        (res) => {
          console.log("临时图片路径创建成功", JSON.stringify(res));
          uni.compressImage({
            src: res.target,
            width: data.width || "auto",
            height: data.height || "auto",
            ...(data.compressedWidth
              ? { compressedWidth: data.compressedWidth }
              : {}),
            ...(data.compressedHeight
              ? { compressedHeight: data.compressedHeight }
              : {}),
            success: (compressImageRes) => {
              console.log("压缩图片成功", JSON.stringify(res));
              plusGallerySave(compressImageRes.tempFilePath)
                .then((successRes) => {
                  console.log("保存图片成功", JSON.stringify(successRes));
                  uni.showToast({
                    title: "图片保存成功",
                    icon: "none",
                  });
                  bitmap.clear();
                })
                .catch(() => {
                  bitmap.clear();
                });
            },
            fail: (err) => {
              console.log("压缩图片失败", JSON.stringify(err));
              uni.showToast({
                title: err.message || "压缩图片失败",
                icon: "none",
              });
              bitmap.clear();
            },
          });
        },
        (e) => {
          console.log("临时图片路径创建失败", JSON.stringify(e));
          uni.showToast({
            title: e.message || "临时图片路径创建失败",
            icon: "none",
          });
        },
      );
    },
    (e) => {
      console.log("加载图片失败", JSON.stringify(e));
      uni.showToast({
        title: e.message || "加载图片失败",
        icon: "none",
      });
    },
  );
};

export const plusGeolocationGetCurrentPosition = (
  options: PlusGeolocationPositionOptions,
): Promise<PlusGeolocationPosition> => {
  return new Promise((resolve, reject) => {
    return checkRequestPermission("Location").then((flag) => {
      if (!flag) {
        return reject(false);
      }
      plus.geolocation.getCurrentPosition(
        (res) => {
          return resolve(res);
        },
        (err) => {
          uni.showToast({
            title: err.message || "获取位置失败",
            icon: "none",
          });
          return reject(err);
        },
        options,
      );
    });
  });
};

export const plusScanCode = (
  options?: UniApp.ScanCodeOptions,
): Promise<UniApp.ScanCodeSuccessRes> => {
  return new Promise((resolve, reject) => {
    checkRequestPermission("Camera").then((res) => {
      if (res) {
        uni.scanCode({
          ...(options || {}),
          success: (scanRes) => {
            return resolve(scanRes);
          },
          fail: (err) => {
            console.log("扫描fail", err);
            if (err.errMsg === "scanCode:fail cancel") {
              return reject(err);
            }
            uni.showToast({
              title: err.message || "扫描失败",
              icon: "none",
            });
            return reject(err);
          },
        });
      } else {
        return reject(false);
      }
    });
  });
};

export const scanBase64Code = (data: {
  base64Str: string;
  fileName?: string;
  suffix?: string;
  quality?: number;
  filters?: (number | undefined)[];
  autoDecodeCharset?: boolean;
}): Promise<{
  type: number;
  code: string;
  file: string;
  charset: string;
}> => {
  return new Promise((resolve, reject) => {
    if (!plus.nativeObj.Bitmap) {
      uni.showToast({
        title: "当前环境不支持保存图片",
        icon: "none",
      });
      return reject(false);
    }

    const filters = (data.filters || [
      plus.barcode.QR,
      plus.barcode.EAN13,
      plus.barcode.EAN8,
    ]) as unknown as Parameters<typeof plus.barcode.scan>[3];
    const bitmap = new plus.nativeObj.Bitmap();
    bitmap.loadBase64Data(
      data.base64Str,
      () => {
        bitmap.save(
          `_doc/${data.fileName || new Date().getTime()}.${
            data.suffix || "png"
          }`,
          { overwrite: true, quality: data.quality || 100 },
          (res) => {
            console.log("临时图片路径创建成功", JSON.stringify(res));
            plus.barcode.scan(
              res.target,
              (type, code, file, charset) => {
                bitmap.clear();
                return resolve({ type, code, file, charset });
              },
              (e) => {
                console.log("解码失败", JSON.stringify(e));
                uni.showToast({
                  title: e.message || "解码失败",
                  icon: "none",
                });
                bitmap.clear();
                return reject(e);
              },
              filters,
              data.autoDecodeCharset,
            );
          },
          (e) => {
            console.log("临时图片路径创建失败", JSON.stringify(e));
            uni.showToast({
              title: e.message || "临时图片路径创建失败",
              icon: "none",
            });
            return reject(e);
          },
        );
      },
      (e) => {
        console.log("加载图片失败", JSON.stringify(e));
        uni.showToast({
          title: e.message || "加载图片失败",
          icon: "none",
        });
        return reject(e);
      },
    );
  });
};
```
