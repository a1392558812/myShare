# plus 封装

```typescript
import { checkRequestPermission } from "04.杂项整理/16.uniapp的plus权限申请.md";

export const plusGalleryPick = (
  options: PlusGalleryGalleryOptions
): Promise<string> => {
  return new Promise((resolve, reject) => {
    return checkRequestPermission("CameraPhotos")
      .then((flag) => {
        if (!flag) {
          return reject(false);
        }
        plus.gallery.pick(
          (res) => {
            return resolve(res);
          },
          (err) => {
            console.log("文件选择失败", JSON.stringify(err));
            if (
              ["用户取消", "User cancelled"].includes(err.message) ||
              [-2].includes(err.code)
            ) {
              return reject(err);
            }
            uni.showToast({
              title: err.message || "文件选择失败",
              icon: "none",
            });
            return reject(err);
          },
          options
        );
      })
      .catch((err) => {
        return reject(err);
      });
  });
};

export const plusGallerySave = (
  path: string
): Promise<PlusGalleryGallerySaveEvent> => {
  return new Promise((resolve, reject) => {
    return checkRequestPermission("Photos")
      .then((flag) => {
        if (!flag) {
          return reject(false);
        }
        return plus.gallery.save(
          path,
          (res) => {
            return resolve(res);
          },
          (err) => {
            console.log("保存图片失败", JSON.stringify(err));
            uni.showToast({
              title: err.message || "保存图片失败",
              icon: "none",
            });
            return reject(err);
          }
        );
      })
      .catch((err) => {
        return reject(err);
      });
  });
};

export const saveBase64Pic = (data: {
  base64Str: string;
  fileName?: string;
  suffix?: string;
  quality?: number;
}) => {
  if (!plus.nativeObj.Bitmap) {
    return uni.showToast({
      title: "当前环境不支持保存图片",
      icon: "none",
    });
  }
  const bitmap = new plus.nativeObj.Bitmap();
  bitmap.loadBase64Data(
    data.base64Str,
    () => {
      bitmap.save(
        `_doc/${data.fileName || new Date().getTime()}.${data.suffix || "jpg"}`,
        {
          overwrite: true,
          quality: data.quality || 100,
        },
        (res) => {
          console.log("临时图片路径创建成功", JSON.stringify(res));
          plusGallerySave(res.target)
            .then((successRes) => {
              console.log("保存图片成功", JSON.stringify(successRes));
              uni.showToast({
                title: "图片保存成功",
                icon: "none",
              });
              bitmap.clear();
            })
            .catch(() => {
              bitmap.clear();
            });
        },
        (e) => {
          console.log("临时图片路径创建失败", JSON.stringify(e));
          uni.showToast({
            title: e.message || "临时图片路径创建失败",
            icon: "none",
          });
        }
      );
    },
    (e) => {
      console.log("加载图片失败", JSON.stringify(e));
      uni.showToast({
        title: e.message || "加载图片失败",
        icon: "none",
      });
    }
  );
};

export const plusGeolocationGetCurrentPosition = (
  options: PlusGeolocationPositionOptions
): Promise<PlusGeolocationPosition> => {
  return new Promise((resolve, reject) => {
    return checkRequestPermission("Location").then((flag) => {
      if (!flag) {
        return reject(false);
      }
      plus.geolocation.getCurrentPosition(
        (res) => {
          return resolve(res);
        },
        (err) => {
          uni.showToast({
            title: err.message || "获取位置失败",
            icon: "none",
          });
          return reject(err);
        },
        options
      );
    });
  });
};

export const plusScanCode = (
  options?: UniApp.ScanCodeOptions
): Promise<UniApp.ScanCodeSuccessRes> => {
  return new Promise((resolve, reject) => {
    checkRequestPermission("Camera").then((res) => {
      if (res) {
        uni.scanCode({
          ...(options || {}),
          success: (scanRes) => {
            return resolve(scanRes);
          },
          fail: (err) => {
            console.log("扫描fail", err);
            if (err.errMsg === "scanCode:fail cancel") {
              return reject(err);
            }
            uni.showToast({
              title: err.message || "扫描失败",
              icon: "none",
            });
            return reject(err);
          },
        });
      } else {
        return reject(false);
      }
    });
  });
};

export const scanBase64Code = (data: {
  base64Str: string;
  fileName?: string;
  suffix?: string;
  quality?: number;
  filters?: (number | undefined)[];
  autoDecodeCharset?: boolean;
}): Promise<{
  type: number;
  code: string;
  file: string;
  charset: string;
}> => {
  return new Promise((resolve, reject) => {
    if (!plus.nativeObj.Bitmap) {
      uni.showToast({
        title: "当前环境不支持保存图片",
        icon: "none",
      });
      return reject(false);
    }

    const filters = (data.filters || [
      plus.barcode.QR,
      plus.barcode.EAN13,
      plus.barcode.EAN8,
    ]) as unknown as Parameters<typeof plus.barcode.scan>[3];
    const bitmap = new plus.nativeObj.Bitmap();
    bitmap.loadBase64Data(
      data.base64Str,
      () => {
        bitmap.save(
          `_doc/${data.fileName || new Date().getTime()}.${
            data.suffix || "png"
          }`,
          { overwrite: true, quality: data.quality || 100 },
          (res) => {
            console.log("临时图片路径创建成功", JSON.stringify(res));
            plus.barcode.scan(
              res.target,
              (type, code, file, charset) => {
                bitmap.clear();
                return resolve({ type, code, file, charset });
              },
              (e) => {
                console.log("解码失败", JSON.stringify(e));
                uni.showToast({
                  title: e.message || "解码失败",
                  icon: "none",
                });
                bitmap.clear();
                return reject(e);
              },
              filters,
              data.autoDecodeCharset
            );
          },
          (e) => {
            console.log("临时图片路径创建失败", JSON.stringify(e));
            uni.showToast({
              title: e.message || "临时图片路径创建失败",
              icon: "none",
            });
            return reject(e);
          }
        );
      },
      (e) => {
        console.log("加载图片失败", JSON.stringify(e));
        uni.showToast({
          title: e.message || "加载图片失败",
          icon: "none",
        });
        return reject(e);
      }
    );
  });
};
```
