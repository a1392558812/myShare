# uniapp 裁剪图片

> alipay-support

```html
<template>
  <view class="uni-content-info">
    <view class="cropper-content">
      <view v-if="showImage" class="uni-corpper">
        <view class="uni-corpper-content">
          <image
            class="uni-corpper-content-image"
            :src="imageSrc"
            mode="aspectFit"
            :style="'transform:rotate(' + rotateAll + 'deg) rotateY(' + rotateY + 'deg) rotateX(' + rotateX + 'deg)'"
          >
          </image>
          <view
            class="uni-corpper-crop-box"
            @touchstart.stop="contentStartMove"
            @touchmove.stop="contentMoveing"
            @touchend.stop="contentTouchEnd"
            :style="'left:' + cutL + 'rpx;top:' + cutT + 'rpx;right:' + cutR + 'rpx;bottom:' + cutB + 'rpx'"
          >
            <view class="uni-cropper-view-box">
              <view class="uni-cropper-dashed-h"></view>
              <view class="uni-cropper-dashed-v"></view>
              <view
                class="uni-cropper-line-t"
                data-drag="top"
                @touchstart.stop="dragStart"
                @touchmove.stop="dragMove"
              >
              </view>
              <view
                class="uni-cropper-line-r"
                data-drag="right"
                @touchstart.stop="dragStart"
                @touchmove.stop="dragMove"
              ></view>
              <view
                class="uni-cropper-line-b"
                data-drag="bottom"
                @touchstart.stop="dragStart"
                @touchmove.stop="dragMove"
              ></view>
              <view
                class="uni-cropper-line-l"
                data-drag="left"
                @touchstart.stop="dragStart"
                @touchmove.stop="dragMove"
              >
              </view>
              <view
                class="uni-cropper-point point-t"
                data-drag="top"
                @touchstart.stop="dragStart"
                @touchmove.stop="dragMove"
              ></view>
              <view
                class="uni-cropper-point point-tr"
                data-drag="topTight"
              ></view>
              <view
                class="uni-cropper-point point-r"
                data-drag="right"
                @touchstart.stop="dragStart"
                @touchmove.stop="dragMove"
              ></view>
              <view
                class="uni-cropper-point point-rb"
                data-drag="rightBottom"
                @touchstart.stop="dragStart"
                @touchmove.stop="dragMove"
              ></view>
              <view
                class="uni-cropper-point point-b"
                data-drag="bottom"
                @touchstart.stop="dragStart"
                @touchmove.stop="dragMove"
                @touchend.stop="dragEnd"
              ></view>
              <view
                class="uni-cropper-point point-bl"
                data-drag="bottomLeft"
              ></view>
              <view
                class="uni-cropper-point point-l"
                data-drag="left"
                @touchstart.stop="dragStart"
                @touchmove.stop="dragMove"
              ></view>
              <view
                class="uni-cropper-point point-lt"
                data-drag="leftTop"
              ></view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <canvas
      class="cropper-canvas"
      id="imageCanvas"
      canvas-id="imageCanvas"
    ></canvas>
  </view>
</template>

<script>
  let PAGE_X,
    PAGE_Y,
    T_PAGE_X,
    T_PAGE_Y,
    CUT_L,
    CUT_T,
    CUT_R,
    CUT_B,
    IMG_RATIO,
    IMG_REAL_W,
    IMG_REAL_H,
    DRAFG_MOVE_RATIO = 1;

  export default {
    props: {
      avatar: {
        type: String,
      },
    },
    data() {
      return {
        showImage: false,

        imageSrc: "",
        imageViewSrc: "",

        cutL: 150,
        cutT: 150,
        cutB: 150,
        cutR: 150,

        rotateX: 0,
        rotateY: 0,
        rotateAll: 0,

        scaleTate: 1,

        currentH: 0, // px
        currentW: 0, // px
      };
    },
    onReady() {},
    mounted() {
      this.getCurrentWrapHeight();
    },
    methods: {
      getCurrentWrapHeight() {
        return new Promise((resolve, reject) => {
          uni.$u.getRect(".uni-content-info").then((res) => {
            console.log("getCurrentWrapHeight", res);
            this.currentH = res.height;
            this.currentW = res.width;
            resolve();
          });
        });
      },
      setData(obj) {
        Object.keys(obj).forEach((key) => {
          this.$set(this.$data, key, obj[key]);
        });
      },
      getImage(res) {
        this.setData({
          imageSrc: res,
        });
        this.loadImage();
      },
      loadImage() {
        if (!this.imageSrc) return;
        uni.getImageInfo({
          src: this.imageSrc,
          success: (res) => {
            this.getCurrentWrapHeight().then(() => {
              IMG_RATIO = res.width / res.height;
              let scaleTate = 1;
              const wrap_scale = this.currentW / this.currentH;

              if (IMG_RATIO >= wrap_scale) {
                IMG_REAL_W = this.currentW;
                IMG_REAL_H = this.currentW / IMG_RATIO;
                scaleTate = res.width / this.currentW;
              } else {
                IMG_REAL_W = this.currentH * IMG_RATIO;
                IMG_REAL_H = this.currentH;
                scaleTate = res.height / this.currentH;
              }

              console.log("loadImage", {
                res,
                IMG_RATIO,
                IMG_REAL_W,
                IMG_REAL_H,
                scaleTate,
                wrap_scale,
                currentW: this.currentW,
                currentH: this.currentH,
              });
              this.setData({
                showImage: true,
                rotateY: 0,
                rotateX: 0,
                rotateAll: 0,
                scaleTate: scaleTate > 1 ? scaleTate : 1,
              });

              // #ifdef MP-WEIXIN
              this.setData({
                imageSrc: res.path,
              });
              // #endif

              uni.hideLoading();
            });
          },
        });
      },
      changeScale(num) {
        let newL = 0;
        let newR = 0;
        let newT = 0;
        let newB = 0;
        if (this.cutL - num > 0) {
          newL = this.cutL - num;
        }
        if (this.cutR - num > 0) {
          newR = this.cutR - num;
        }
        if (newL + newR >= this.currentW) {
          newL = this.cutL;
          newR = this.cutR;
        }
        if (this.cutT - num > 0) {
          newT = this.cutT - num;
        }
        if (this.cutB - num > 0) {
          newB = this.cutB - num;
        }
        if (newL + newR >= this.currentW) {
          newT = this.cutT;
          newB = this.cutB;
        }
        this.setData({
          cutL: newL,
          cutT: newT,
          cutR: newR,
          cutB: newB,
        });
      },
      rotateRight(num) {
        let rotate = this.rotateAll + num;
        if (rotate < 0) {
          rotate += 360;
        }
        this.setData({
          rotateAll: rotate % 360,
        });
      },
      refresh() {
        this.setData({
          cutL: 150,
          cutT: 150,
          cutR: 150,
          cutB: 150,
          rotateY: 0,
          rotateX: 0,
          rotateAll: 0,
        });
      },
      rotateTopButtom() {
        this.setData({
          rotateY: 180 - this.rotateY,
        });
      },
      rotateLeftRight() {
        this.setData({
          rotateX: 180 - this.rotateX,
        });
      },
      // 获取图片
      getImageInfo() {
        return new Promise((resolve, reject) => {
          let ctx = uni.createCanvasContext("imageCanvas");

          ctx.clearRect(0, 0, this.currentW, this.currentH);
          ctx.setTransform(1, 0, 0, 1, 0, 0);
          ctx.translate(this.rpxToPx(375), this.currentH / 2);
          ctx.rotate((this.rotateAll * Math.PI) / 180);
          if (this.rotateY == 180 && this.rotateX == 180) {
            ctx.scale(-1, -1);
          } else if (this.rotateY == 180) {
            ctx.scale(-1, 1);
          } else if (this.rotateX == 180) {
            ctx.scale(1, -1);
          }
          ctx.translate(this.rpxToPx(-375), -this.currentH / 2);

          let dx = 0;
          let dy = 0;

          if (IMG_RATIO >= this.currentW / this.currentH) {
            dx = 0;
            dy = this.currentH / 2 - IMG_REAL_H / 2;
          } else {
            dx = this.currentW / 2 - IMG_REAL_W / 2;
            dy = 0;
          }

          ctx.drawImage(this.imageSrc, dx, dy, IMG_REAL_W, IMG_REAL_H);

          console.log("ctx", ctx);
          ctx.draw(true, () => {
            const x = this.rpxToPx(this.cutL);
            const y = this.rpxToPx(this.cutT);
            const width = this.currentW - this.rpxToPx(this.cutL + this.cutR);
            const height = this.currentH - this.rpxToPx(this.cutT + this.cutB);
            console.log("ctx.draw", {
              x,
              y,
              width,
              height,
              scaleTate: this.scaleTate,
            });
            uni.canvasToTempFilePath(
              {
                x,
                y,
                width,
                height,
                destWidth: width * this.scaleTate,
                destHeight: height * this.scaleTate,
                quality: 1,
                canvasId: "imageCanvas",
                success: (res) => {
                  console.log("uni.canvasToTempFilePath-success", res);
                  this.setData({
                    imageViewSrc: res.tempFilePath,
                  });
                  return resolve();
                },
                fail: (err) => {
                  console.log("uni.canvasToTempFilePath-error", err);
                  return reject(err);
                },
              },
              this
            );
          });
        });
      },
      saveImageInfo() {
        return this.getImageInfo().then(() => {
          this.$emit("save", {
            avatar: this.imageViewSrc,
          });
          console.log("saveImageInfo", this.imageViewSrc);
          return Promise.resolve(this.imageViewSrc);
        });
      },
      rpxToPx(i) {
        return uni.rpx2px(i);
      },

      contentStartMove(e) {
        PAGE_X = e.touches[0].pageX;
        PAGE_Y = e.touches[0].pageY;
      },
      contentMoveing(e) {
        let dragLengthX = (PAGE_X - e.touches[0].pageX) * DRAFG_MOVE_RATIO;
        let dragLengthY = (PAGE_Y - e.touches[0].pageY) * DRAFG_MOVE_RATIO;
        if (dragLengthX > 0) {
          if (this.cutL - dragLengthX < 0) dragLengthX = this.cutL;
        } else {
          if (this.cutR + dragLengthX < 0) dragLengthX = -this.cutR;
        }

        if (dragLengthY > 0) {
          if (this.cutT - dragLengthY < 0) dragLengthY = this.cutT;
        } else {
          if (this.cutB + dragLengthY < 0) dragLengthY = -this.cutB;
        }
        this.setData({
          cutL: this.cutL - dragLengthX,
          cutT: this.cutT - dragLengthY,
          cutR: this.cutR + dragLengthX,
          cutB: this.cutB + dragLengthY,
        });

        PAGE_X = e.touches[0].pageX;
        PAGE_Y = e.touches[0].pageY;
      },
      contentTouchEnd() {},
      dragStart(e) {
        T_PAGE_X = e.touches[0].pageX;
        T_PAGE_Y = e.touches[0].pageY;
        CUT_L = this.cutL;
        CUT_R = this.cutR;
        CUT_B = this.cutB;
        CUT_T = this.cutT;
      },
      dragMove(e) {
        let dragType = e.target.dataset.drag;
        switch (dragType) {
          case "right":
            let dragLengthR =
              (T_PAGE_X - e.touches[0].pageX) * DRAFG_MOVE_RATIO;
            if (CUT_R + dragLengthR < 0) dragLengthR = -CUT_R;
            this.setData({
              cutR: CUT_R + dragLengthR,
            });
            break;
          case "left":
            let dragLengthL =
              (T_PAGE_X - e.touches[0].pageX) * DRAFG_MOVE_RATIO;
            if (CUT_L - dragLengthL < 0) dragLengthL = CUT_L;
            if (CUT_L - dragLengthL > this.currentW - this.cutR)
              dragLengthL = CUT_L - (this.currentW - this.cutR);
            this.setData({
              cutL: CUT_L - dragLengthL,
            });
            break;
          case "top":
            let dragLengthT =
              (T_PAGE_Y - e.touches[0].pageY) * DRAFG_MOVE_RATIO;
            if (CUT_T - dragLengthT < 0) dragLengthT = CUT_T;
            if (CUT_T - dragLengthT > this.currentW - this.cutB)
              dragLengthT = CUT_T - (this.currentW - this.cutB);
            this.setData({
              cutT: CUT_T - dragLengthT,
            });
            break;
          case "bottom":
            let dragLengthB =
              (T_PAGE_Y - e.touches[0].pageY) * DRAFG_MOVE_RATIO;
            if (CUT_B + dragLengthB < 0) dragLengthB = -CUT_B;
            this.setData({
              cutB: CUT_B + dragLengthB,
            });
            break;
          case "rightBottom":
            let dragLengthRBX =
              (T_PAGE_X - e.touches[0].pageX) * DRAFG_MOVE_RATIO;
            let dragLengthRBY =
              (T_PAGE_Y - e.touches[0].pageY) * DRAFG_MOVE_RATIO;

            if (CUT_B + dragLengthRBY < 0) dragLengthRBY = -CUT_B;
            if (CUT_R + dragLengthRBX < 0) dragLengthRBX = -CUT_R;
            let cutB = CUT_B + dragLengthRBY;
            let cutR = CUT_R + dragLengthRBX;

            this.setData({
              cutB: cutB,
              cutR: cutR,
            });
            break;
          default:
            break;
        }
      },
      dragEnd() {},
    },
  };
</script>

<style scoped lang="scss">
  .uni-content-info {
    overflow-y: auto;
    width: 100%;
    height: 100%;
    position: relative;

    .cropper-content {
      width: 100%;
      height: 100%;

      .uni-corpper {
        position: relative;
        overflow: hidden;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
        box-sizing: border-box;
        width: 100%;
        height: 100%;
        background: #000;

        .uni-corpper-content {
          position: relative;
          width: 100%;
          height: 100%;
          left: 0rpx;
          top: 0rpx;

          .uni-corpper-content-image {
            display: block;
            /* width: 100%; */
            min-width: 0 !important;
            max-width: none !important;
            /* height: 100%; */
            min-height: 0 !important;
            max-height: none !important;
            image-orientation: 0deg !important;
            margin: 0 auto;
            width: 100%;
            height: 100%;
          }

          .uni-corpper-crop-box {
            position: absolute;
            background: rgba(255, 255, 255, 0.3);
            z-index: 2;

            .uni-cropper-view-box {
              position: relative;
              display: block;
              width: 100%;
              height: 100%;
              overflow: visible;
              outline: 1rpx solid #69f;
              outline-color: rgba(102, 153, 255, 0.75);

              /* 横向虚线 */

              .uni-cropper-dashed-h {
                position: absolute;
                top: 33.33333333%;
                left: 0;
                width: 100%;
                height: 33.33333333%;
                border-top: 1rpx dashed rgba(255, 255, 255, 0.5);
                border-bottom: 1rpx dashed rgba(255, 255, 255, 0.5);
              }

              /* 纵向虚线 */

              .uni-cropper-dashed-v {
                position: absolute;
                left: 33.33333333%;
                top: 0;
                width: 33.33333333%;
                height: 100%;
                border-left: 1rpx dashed rgba(255, 255, 255, 0.5);
                border-right: 1rpx dashed rgba(255, 255, 255, 0.5);
              }

              /* 四个方向的线  为了之后的拖动事件*/

              .uni-cropper-line-t {
                position: absolute;
                display: block;
                width: 100%;
                background-color: #69f;
                top: 0;
                left: 0;
                height: 1rpx;
                opacity: 0.1;
                cursor: n-resize;

                &::before {
                  content: "";
                  position: absolute;
                  top: 50%;
                  right: 0rpx;
                  width: 100%;
                  -webkit-transform: translate3d(0, -50%, 0);
                  transform: translate3d(0, -50%, 0);
                  bottom: 0;
                  height: 41rpx;
                  background: transparent;
                  z-index: 11;
                }
              }

              .uni-cropper-line-r {
                position: absolute;
                display: block;
                background-color: #69f;
                top: 0;
                right: 0rpx;
                width: 1rpx;
                opacity: 0.1;
                height: 100%;
                cursor: e-resize;

                &::before {
                  content: "";
                  position: absolute;
                  top: 0;
                  left: 50%;
                  width: 41rpx;
                  -webkit-transform: translate3d(-50%, 0, 0);
                  transform: translate3d(-50%, 0, 0);
                  bottom: 0;
                  height: 100%;
                  background: transparent;
                  z-index: 11;
                }
              }

              .uni-cropper-line-b {
                position: absolute;
                display: block;
                width: 100%;
                background-color: #69f;
                bottom: 0;
                left: 0;
                height: 1rpx;
                opacity: 0.1;
                cursor: s-resize;

                &::before {
                  content: "";
                  position: absolute;
                  top: 50%;
                  right: 0rpx;
                  width: 100%;
                  -webkit-transform: translate3d(0, -50%, 0);
                  transform: translate3d(0, -50%, 0);
                  bottom: 0;
                  height: 41rpx;
                  background: transparent;
                  z-index: 11;
                }
              }

              .uni-cropper-line-l {
                position: absolute;
                display: block;
                background-color: #69f;
                top: 0;
                left: 0;
                width: 1rpx;
                opacity: 0.1;
                height: 100%;
                cursor: w-resize;

                &::before {
                  content: "";
                  position: absolute;
                  top: 0;
                  left: 50%;
                  width: 41rpx;
                  -webkit-transform: translate3d(-50%, 0, 0);
                  transform: translate3d(-50%, 0, 0);
                  bottom: 0;
                  height: 100%;
                  background: transparent;
                  z-index: 11;
                }
              }

              .uni-cropper-point {
                width: 5rpx;
                height: 5rpx;
                background-color: #69f;
                opacity: 0.75;
                position: absolute;
                z-index: 3;
              }

              .point-t {
                top: -3rpx;
                left: 50%;
                margin-left: -3rpx;
                cursor: n-resize;
              }

              .point-tr {
                top: -3rpx;
                left: 100%;
                margin-left: -3rpx;
                cursor: n-resize;
              }

              .point-r {
                top: 50%;
                left: 100%;
                margin-left: -3rpx;
                margin-top: -3rpx;
                cursor: n-resize;
              }

              .point-rb {
                left: 100%;
                top: 100%;
                -webkit-transform: translate3d(-50%, -50%, 0);
                transform: translate3d(-50%, -50%, 0);
                cursor: n-resize;
                width: 36rpx;
                height: 36rpx;
                background-color: #69f;
                position: absolute;
                z-index: 1112;
                opacity: 1;
              }

              .point-b {
                left: 50%;
                top: 100%;
                margin-left: -3rpx;
                margin-top: -3rpx;
                cursor: n-resize;
              }

              .point-bl {
                left: 0%;
                top: 100%;
                margin-left: -3rpx;
                margin-top: -3rpx;
                cursor: n-resize;
              }

              .point-l {
                left: 0%;
                top: 50%;
                margin-left: -3rpx;
                margin-top: -3rpx;
                cursor: n-resize;
              }

              .point-lt {
                left: 0%;
                top: 0%;
                margin-left: -3rpx;
                margin-top: -3rpx;
                cursor: n-resize;
              }
            }
          }
        }
      }
    }
  }

  .cropper-canvas {
    position: absolute;
    width: 100%;
    height: 100%;
    top: -9999rpx;
    left: -9999rpx;
  }
</style>
```
