# uniapp 省市区三级联动

```html
<template>
  <view>
    <uv-picker
      ref="pickerRef"
      :loading="loading"
      key-name="name"
      :columns="addressPickerColumns"
      @change="addressChange"
      @confirm="confirm"
    />
  </view>
</template>

<script setup lang="ts">
  import { getRegionList } from "@/request/api/index/index";
  import { onLoad } from "@dcloudio/uni-app";
  import { computed, nextTick, reactive, ref } from "vue";

  export interface ListItemType {
    id: string;
    provinceId: string;
    province: string;
    cityId: string;
    city: string;
    districtId: string;
    district: string;
    address: string;
  }

  const loading = ref(false);

  const optionsData = reactive<ListItemType>({
    id: "",
    provinceId: "",
    province: "",
    cityId: "",
    city: "",
    districtId: "",
    district: "",
    address: "",
    level: 1;
  });

  interface RegionItemType {
    id: string;
    name: string;
    level: number;
  }

  const pickerRef = ref<any>();
  const provincesList = ref<RegionItemType[]>([]);
  const citiesList = ref<RegionItemType[]>([]);
  const districtsList = ref<RegionItemType[]>([]);

  const defaultValue = ref<[RegionItemType, RegionItemType, RegionItemType]>([
    { id: "", name: "", level: 1 },
    { id: "", name: "", level: 2 },
    { id: "", name: "", level: 3 },
  ]);
  const address = ref("");

  const addressStr = computed(() => {
    if (
      defaultValue.value[0].name &&
      defaultValue.value[1].name &&
      defaultValue.value[2].name
    ) {
      return `${defaultValue.value[0].name}-${defaultValue.value[1].name}-${defaultValue.value[2].name}`;
    }
    return "请选择地址";
  });

  const addressPickerColumns = computed(() => {
    return [provincesList.value, citiesList.value, districtsList.value];
  });

  const getList = (data: {
    level: number;
    fatherId: string;
  }): Promise<RegionItemType[]> => {
    loading.value = true;
    return new Promise((resolve, reject) => {
      getRegionList(data.fatherId)
        .promise.then((res) => {
          loading.value = false;
          if (res.code === "00000") {
            return resolve(res.data || []);
          } else {
            uni.showToast({
              title: res.message || "获取区域列表失败",
              icon: "none",
            });
            return reject(res);
          }
        })
        .catch((err) => {
          loading.value = false;
          return reject(err);
        });
    });
  };

  const addressChange = (e: {
    columnIndex: number;
    index: number;
    indexs: number[];
  }) => {
    try {
      if (loading.value) {
        return Promise.reject(false);
      }

      if (e.columnIndex === -1) {
        uni.showLoading({
          title: "",
          mask: true,
        });

        let targetIndex0 = -1;
        let targetIndex1 = -1;
        let targetIndex2 = -1;
        return getList({ level: 1, fatherId: "-1" })
          .then((list) => {
            provincesList.value = list;
            targetIndex0 = list.findIndex((item) => item.id === optionsData.provinceId);
            targetIndex0 = targetIndex0 === -1 ? 0 : targetIndex0;
            defaultValue.value[0].id = provincesList.value[targetIndex0].provinceId || "";
            defaultValue.value[0].name = provincesList.value[targetIndex0].province || "";
            return getList({
              level: 2,
              fatherId: defaultValue.value[0].id,
            });
          })
          .then((list) => {
            citiesList.value = list || [];
            targetIndex1 = citiesList.value.findIndex((item) => item.id === optionsData.cityId);
            targetIndex1 = targetIndex1 === -1 ? 0 : targetIndex1;
            defaultValue.value[1].id = citiesList.value[targetIndex1].cityId || "";
            defaultValue.value[1].name = citiesList.value[targetIndex1].city || "";
            return getList({
              level: 3,
              fatherId: defaultValue.value[1].id,
            });
          })
          .then((list) => {
            uni.hideLoading();
            districtsList.value = list || [];
            targetIndex2 = districtsList.value.findIndex((item) => item.id === optionsData.districtId);
            targetIndex2 = targetIndex2 === -1 ? 0 : targetIndex2;
            defaultValue.value[2].id = districtsList.value[targetIndex2].districtId || "";
            defaultValue.value[2].name = districtsList.value[targetIndex2].district || "";
            pickerRef.value.setIndexs(
              [targetIndex0, targetIndex1, targetIndex2],
              true
            );
            return Promise.resolve(true);
          })
          .catch((err) => {
            console.log("getRegionList error", err);
            uni.hideLoading();
            return Promise.reject(err)
          });
      }

      if (e.columnIndex === 0) {
        uni.showLoading({
          title: "",
          mask: true,
        });

        return getList({
          level: 2,
          fatherId: provincesList.value[e.indexs[0]].provinceId,
        })
          .then((list) => {
            citiesList.value = list;
            return getList({
              level: 3,
              fatherId: citiesList.value[e.indexs[1]].cityId,
            });
          })
          .then((list) => {
            uni.hideLoading();

            districtsList.value = list || [];
            pickerRef.value.setIndexs([e.indexs[0], 0, 0], true);
            return Promise.resolve(true);
          })
          .catch((err) => {
            uni.hideLoading();
            return Promise.reject(err)
          });
      }

      if (e.columnIndex === 1) {
        uni.showLoading({
          title: "",
          mask: true,
        });
        return getList({
          level: 3,
          fatherId: citiesList.value[e.indexs[1]].cityId,
        })
          .then((list) => {
            uni.hideLoading();

            districtsList.value = list || [];
            pickerRef.value.setIndexs([e.indexs[0], e.indexs[1], 0], true);
            return Promise.resolve(true);
          })
          .catch((err) => {
            uni.hideLoading();
            return Promise.reject(err)
          });
      }

      if (e.columnIndex === 2) {
        pickerRef.value.setIndexs(e.indexs, true);
        return Promise.resolve(true);
      }
    } catch (err: any) {
      console.log("addressChange error", err);
      loading.value = false;
      return Promise.reject(false);
    }
  };

  const confirm = (e: { value: RegionItemType[]; indexs: number[] }) => {
    defaultValue.value[0].id = e.value[0].id || "";
    defaultValue.value[1].id = e.value[1].id || "";
    defaultValue.value[2].id = e.value[2].id || "";
    defaultValue.value[0].name = e.value[0].province || "";
    defaultValue.value[1].name = e.value[1].city || "";
    defaultValue.value[2].name = e.value[2].district || "";
    console.log("confirm", e);
  };

  const onOpenAddressPicker = (params?: ListItemType) => {
    Object.assign(optionsData, params || {});
    nextTick(() => {
      addressChange({ columnIndex: -1, index: 0, indexs: [0, 0, 0] }).then(() => {
        pickerRef.value.open();
      })
    });
  };

  defineExpose({
    onOpenAddressPicker,
  });
</script>
```
