# uniapp 中 plus 权限申请

> 原作者：[梅竹生辉](https://ext.dcloud.net.cn/publisher?id=202326)
> 源地址：[https://ext.dcloud.net.cn/plugin?id=25286](https://ext.dcloud.net.cn/plugin?id=25286)
> 请大家多多支持原作者，开源不易

此处我只是将 js 转为 ts 并添加了类型定义，没有做其他修改。

```typescript
interface PermissionInfo {
  name: string;
  title: string;
  content: string;
}

interface PermissionResult {
  granted: string[];
  deniedPresent: string[];
  deniedAlways: string[];
}

type PermissionType =
  | "Camera"
  | "Photos"
  | "CameraPhotos"
  | "Microphone"
  | "Phone"
  | "Location";

let isIos: boolean = false;
// #ifdef APP-PLUS
isIos = plus.os.name === "iOS";
// #endif
const viewShow: boolean = true;

console.log("isIos", isIos);

const gotoAppPermissionSetting = (): void => {
  uni.showModal({
    title: "提示",
    content: "操作权限已被拒绝，请手动前往设置",
    confirmText: "立即设置",
    success: (res) => {
      if (res.confirm) {
        uni.openAppAuthorizeSetting();
      }
    },
  });
};

const Permission: Record<PermissionType, PermissionInfo> = {
  CameraPhotos: {
    name: "android.permission.READ_EXTERNAL_STORAGE,android.permission.WRITE_EXTERNAL_STORAGE,android.permission.CAMERA",
    title: "相机/相册权限说明",
    content:
      "便于您使用该功能上传您的照片/图片/视频及用于素材处理、与客服沟通等场景中读取相册和文件内容",
  },
  Camera: {
    name: "android.permission.CAMERA",
    title: "相机权限说明",
    content: "便于您使用该功能拍照素材处理、与客服沟通等场景中发送拍摄图片",
  },
  Photos: {
    name: "android.permission.READ_EXTERNAL_STORAGE,android.permission.WRITE_EXTERNAL_STORAGE",
    title: "相册权限说明",
    content:
      "便于您使用该功能上传您的照片/图片/视频及用于素材处理、与客服沟通等场景中读取相册和文件内容",
  },
  Microphone: {
    name: "android.permission.RECORD_AUDIO",
    title: "录音权限说明",
    content: "便于使用声音克隆，或者语音转文字等功能",
  },
  Phone: {
    name: "android.permission.READ_PHONE_STATE",
    title: "电话/设备状态权限说明",
    content:
      "用于获取唯一设备识别码IMEI，以提供统计分析服务，为用户提供更好的服务",
  },
  Location: {
    name: "android.permission.ACCESS_FINE_LOCATION",
    title: "位置权限说明",
    content: "用户获取城市位置，快速展示不同的信息，为用户提供更好的服务",
  },
};

enum PermissionStatus {
  denied = "denied",
  granted = "granted",
  restricted = "restricted",
  limited = "limited",
  permanentlyDenied = "permanentlyDenied",
}

let view: any = null;

const showViewDesc = (permission: PermissionType): void => {
  if (isIos) {
    return;
  }
  const permissionInfo = Permission[permission];
  console.log("permissionInfo", permissionInfo);

  if (permissionInfo) {
    view = new plus.nativeObj.View("per-modal", {
      top: "0px",
      left: "0px",
      width: "100%",
      backgroundColor: "rgba(0,0,0,0.2)",
      // opacity: '.9'
    });
    view.drawRect(
      {
        color: "#fff",
        radius: "5px",
      },
      {
        top: "30px",
        left: "5%",
        width: "90%",
        height: "100px",
      }
    );
    view.drawText(
      permissionInfo.title,
      {
        top: "40px",
        left: "8%",
        height: "30px",
      },
      {
        align: "left",
        color: "#000",
      },
      {
        onClick: (e: any) => {
          console.log(e);
        },
      }
    );
    view.drawText(
      permissionInfo.content,
      {
        top: "65px",
        height: "60px",
        left: "8%",
        width: "84%",
      },
      {
        whiteSpace: "normal",
        size: "14px",
        align: "left",
        color: "#656563",
      }
    );
    setTimeout(() => {
      if (viewShow && view) view.show();
    }, 200);
  }
};

const closeViewDesc = (): void => {
  if (view) {
    try {
      view.close();
    } catch (error) {
      console.log(error);
    }
    view = null;
  }
};

const checkAndroidPermission = (
  permission: PermissionInfo
): PermissionStatus => {
  const permissionIds = permission.name;

  const ids = permissionIds.split(",");
  let finalStatus: PermissionStatus = PermissionStatus.granted;

  for (const id of ids) {
    const permissionId = id.trim();
    if (!permissionId) continue;

    const status = plus.navigator.checkPermission(
      permissionId as PlusNavigatorPermissionNames
    );

    switch (status) {
      case "denied":
        return PermissionStatus.permanentlyDenied;
      case "undetermined":
        finalStatus = PermissionStatus.denied;
        break;
      case "authorized":
        break;
      default:
        finalStatus = PermissionStatus.denied;
        break;
    }
  }
  return finalStatus;
};
const checkCameraPermission = (): PermissionStatus => {
  if (isIos) {
    const AVCaptureDevice = plus.ios.import("AVCaptureDevice");
    const authStatus = AVCaptureDevice.authorizationStatusForMediaType("vide");
    plus.ios.deleteObject(AVCaptureDevice);
    let status: PermissionStatus;
    switch (authStatus) {
      case 0:
        status = PermissionStatus.denied;
        break;
      case 1:
        status = PermissionStatus.restricted;
        break;
      case 2:
        status = PermissionStatus.permanentlyDenied;
        break;
      case 3:
        status = PermissionStatus.granted;
        break;
      default:
        status = authStatus;
    }

    return status;
  } else {
    return checkAndroidPermission(Permission.Camera);
  }
};

const checkPhotosPermission = (): PermissionStatus => {
  if (isIos) {
    const PHPhotoLibrary = plus.ios.import("PHPhotoLibrary");
    const authStatus = PHPhotoLibrary.authorizationStatus();
    plus.ios.deleteObject(PHPhotoLibrary);
    console.log("camera status", authStatus);
    let status: PermissionStatus;
    switch (authStatus) {
      case 0:
        status = PermissionStatus.denied;
        break;
      case 1:
        status = PermissionStatus.restricted;
        break;
      case 2:
        status = PermissionStatus.permanentlyDenied;
        break;
      case 3:
        status = PermissionStatus.granted;
        break;
      case 4:
        status = PermissionStatus.limited;
        break;
      default:
        status = authStatus;
    }
    return status;
  } else {
    return checkAndroidPermission(Permission.Photos);
  }
};

const checkCameraPhotosPermission = (): PermissionStatus => {
  if (isIos) {
    const cameraStatus = checkCameraPermission();
    const photosStatus = checkPhotosPermission();
    if (
      cameraStatus === PermissionStatus.permanentlyDenied ||
      photosStatus === PermissionStatus.permanentlyDenied
    ) {
      return PermissionStatus.permanentlyDenied;
    }
    if (
      cameraStatus === PermissionStatus.denied ||
      cameraStatus === PermissionStatus.restricted ||
      photosStatus === PermissionStatus.denied ||
      photosStatus === PermissionStatus.restricted
    ) {
      return PermissionStatus.denied;
    }
    if (
      cameraStatus === PermissionStatus.granted &&
      photosStatus === PermissionStatus.granted
    ) {
      return PermissionStatus.granted;
    }
    return PermissionStatus.granted;
  } else {
    return checkAndroidPermission(Permission.CameraPhotos);
  }
};

const checkMicrophonePermission = (): PermissionStatus => {
  if (isIos) {
    const avaudiosession = plus.ios.import("AVAudioSession");
    const avaudio = avaudiosession.sharedInstance();
    const newState = avaudio.recordPermission();
    plus.ios.deleteObject(avaudiosession);

    if (newState === 1970168948) {
      return PermissionStatus.denied;
    } else if (newState === 1684369017) {
      return PermissionStatus.permanentlyDenied;
    } else if (newState === 1735552628) {
      return PermissionStatus.granted;
    } else {
      return newState;
    }
  } else {
    return checkAndroidPermission(Permission.Microphone);
  }
};

const checkPhonePermission = (): PermissionStatus => {
  if (isIos) {
    return PermissionStatus.permanentlyDenied;
  } else {
    return checkAndroidPermission(Permission.Phone);
  }
};

const checkLocationPermission = (): PermissionStatus => {
  if (isIos) {
    const cllocationManger = plus.ios.import("CLLocationManager");
    const authStatus = cllocationManger.authorizationStatus();
    plus.ios.deleteObject(cllocationManger);
    let status: PermissionStatus;
    switch (authStatus) {
      case 0:
        status = PermissionStatus.denied;
        break;
      case 1:
        status = PermissionStatus.restricted;
        break;
      case 2:
        status = PermissionStatus.permanentlyDenied;
        break;
      case 3:
        status = PermissionStatus.granted;
        break;
      case 4:
        status = PermissionStatus.limited;
        break;
      default:
        status = authStatus;
    }
    return status;
  } else {
    return checkAndroidPermission(Permission.Location);
  }
};

export const checkPermission = (
  permission: PermissionType
): PermissionStatus => {
  if (permission === "Camera") {
    return checkCameraPermission();
  } else if (permission === "Photos") {
    return checkPhotosPermission();
  } else if (permission === "CameraPhotos") {
    return checkCameraPhotosPermission();
  } else if (permission === "Microphone") {
    return checkMicrophonePermission();
  } else if (permission === "Phone") {
    return checkPhonePermission();
  } else if (permission === "Location") {
    return checkLocationPermission();
  } else {
    return PermissionStatus.denied;
  }
};

const requestAndroidPermission = (
  permission: PermissionInfo
): Promise<PermissionStatus> => {
  const permissionID = permission.name;
  const permissionIds = permissionID ? permissionID.split(",") : [];
  return new Promise((resolve, reject) => {
    plus.android.requestPermissions(
      permissionIds,
      (resultObj: PermissionResult) => {
        console.log("resultObj", resultObj);
        let result: PermissionStatus = PermissionStatus.denied;
        for (let i = 0; i < resultObj.granted.length; i++) {
          const grantedPermission = resultObj.granted[i];
          console.log(`已获取的权限：${grantedPermission}`);
          result = PermissionStatus.granted;
        }
        for (let j = 0; j < resultObj.deniedPresent.length; j++) {
          const deniedPresentPermission = resultObj.deniedPresent[j];
          console.log(`拒绝本次申请的权限：${deniedPresentPermission}`);
          result = PermissionStatus.denied;
        }
        for (let k = 0; k < resultObj.deniedAlways.length; k++) {
          const deniedAlwaysPermission = resultObj.deniedAlways[k];
          console.log(`永久拒绝申请的权限：${deniedAlwaysPermission}`);
          result = PermissionStatus.permanentlyDenied;
        }
        resolve(result);
      },
      (error: any) => {
        reject(error);
        console.log("申请权限错误", error);
      }
    );
  });
};

const requestCameraPermission = (): Promise<PermissionStatus> => {
  return new Promise((resolve, reject) => {
    if (isIos) {
      console.log("isIos111", isIos);
      // @ts-expect-error (method) PlusIos.invoke(obj: any, name: string, args?: any): any,
      plus.ios.invoke(
        "AVCaptureDevice",
        "requestAccessForMediaType:completionHandler:",
        "vide",
        (granted: boolean) => {
          console.log("granted", granted);
          const AVCaptureDevice = plus.ios.import("AVCaptureDevice");
          const authStatus =
            AVCaptureDevice.authorizationStatusForMediaType("vide");
          plus.ios.deleteObject(AVCaptureDevice);
          let status: PermissionStatus;
          switch (authStatus) {
            case 0:
              status = PermissionStatus.denied;
              break;
            case 1:
              status = PermissionStatus.restricted;
              break;
            case 2:
              status = PermissionStatus.permanentlyDenied;
              break;
            case 3:
              status = PermissionStatus.granted;
              break;
            default:
              status = authStatus;
          }
          resolve(status);
        }
      );
    } else {
      requestAndroidPermission(Permission.Camera)
        .then((res) => {
          resolve(res);
        })
        .catch((err) => {
          reject(err);
        });
    }
  });
};

const requestPhotosPermission = (): Promise<PermissionStatus> => {
  return new Promise((resolve, reject) => {
    if (isIos) {
      const PHPhotoLibrary = plus.ios.import("PHPhotoLibrary");
      PHPhotoLibrary.requestAuthorization(() => {
        const authStatus = PHPhotoLibrary.authorizationStatus();
        plus.ios.deleteObject(PHPhotoLibrary);
        let status: PermissionStatus;
        switch (authStatus) {
          case 0:
            status = PermissionStatus.denied;
            break;
          case 1:
            status = PermissionStatus.restricted;
            break;
          case 2:
            status = PermissionStatus.permanentlyDenied;
            break;
          case 3:
            status = PermissionStatus.granted;
            break;
          case 4:
            status = PermissionStatus.limited;
            break;
          default:
            status = authStatus;
        }
        resolve(status);
      });
    } else {
      requestAndroidPermission(Permission.Photos)
        .then((res) => {
          resolve(res);
        })
        .catch((err) => {
          reject(err);
        });
    }
  });
};

const requestCameraPhotosPermission = (): Promise<PermissionStatus> => {
  return new Promise((resolve, reject) => {
    if (isIos) {
      return Promise.all([
        requestPhotosPermission(),
        requestCameraPermission(),
      ]).then(([photosStatus, cameraStatus]) => {
        if (
          cameraStatus === PermissionStatus.permanentlyDenied ||
          photosStatus === PermissionStatus.permanentlyDenied
        ) {
          return resolve(PermissionStatus.permanentlyDenied);
        }
        if (
          cameraStatus === PermissionStatus.denied ||
          cameraStatus === PermissionStatus.restricted ||
          photosStatus === PermissionStatus.denied ||
          photosStatus === PermissionStatus.restricted
        ) {
          return resolve(PermissionStatus.denied);
        }
        if (
          cameraStatus === PermissionStatus.granted &&
          photosStatus === PermissionStatus.granted
        ) {
          return resolve(PermissionStatus.granted);
        }
        return resolve(PermissionStatus.granted);
      });
    } else {
      requestAndroidPermission(Permission.CameraPhotos)
        .then((res) => {
          resolve(res);
        })
        .catch((err) => {
          reject(err);
        });
    }
  });
};

const requestMicrophonePermission = (): Promise<PermissionStatus> => {
  return new Promise((resolve, reject) => {
    if (isIos) {
      const AVAudioSession = plus.ios.import("AVAudioSession");
      const avaudio = AVAudioSession.sharedInstance();
      avaudio.requestRecordPermission(() => {
        const newState = avaudio.recordPermission();
        plus.ios.deleteObject(AVAudioSession);
        let status: PermissionStatus;
        if (newState === 1970168948) {
          status = PermissionStatus.denied;
        } else if (newState === 1684369017) {
          status = PermissionStatus.permanentlyDenied;
        } else if (newState === 1735552628) {
          status = PermissionStatus.granted;
        } else {
          status = newState;
        }
        resolve(status);
      });
    } else {
      requestAndroidPermission(Permission.Microphone)
        .then((res) => {
          resolve(res);
        })
        .catch((err) => {
          reject(err);
        });
    }
  });
};

const requestPhonePermission = (): Promise<PermissionStatus> => {
  return new Promise((resolve, reject) => {
    if (isIos) {
      resolve(PermissionStatus.permanentlyDenied);
    } else {
      requestAndroidPermission(Permission.Phone)
        .then((res) => {
          resolve(res);
        })
        .catch((err) => {
          reject(err);
        });
    }
  });
};

const requestLocationPermission = (): Promise<PermissionStatus> => {
  return new Promise((resolve, reject) => {
    if (isIos) {
      const CLLocationManager = plus.ios.import("CLLocationManager");
      const manager = plus.ios.newObject("CLLocationManager");

      manager.requestWhenInUseAuthorization(); // 向系统请求「应用使用期间」的定位权限（前台定位）
      // 后台定位 manager.requestAlwaysAuthorization();

      const authStatus = CLLocationManager.authorizationStatus();
      plus.ios.deleteObject(manager);
      plus.ios.deleteObject(CLLocationManager);

      let status: PermissionStatus;
      switch (authStatus) {
        case 0: // kCLAuthorizationStatusNotDetermined
          status = PermissionStatus.denied;
          break;
        case 1: // kCLAuthorizationStatusRestricted
          status = PermissionStatus.restricted;
          break;
        case 2: // kCLAuthorizationStatusDenied
          status = PermissionStatus.permanentlyDenied;
          break;
        case 3: // kCLAuthorizationStatusAuthorizedAlways
        case 4: // kCLAuthorizationStatusAuthorizedWhenInUse
          status = PermissionStatus.granted;
          break;
        default:
          status = authStatus;
      }

      resolve(status);
    } else {
      requestAndroidPermission(Permission.Location)
        .then((res) => {
          resolve(res);
        })
        .catch((err) => {
          reject(err);
        });
    }
  });
};

const requestPermissions = (
  permission: PermissionType
): Promise<PermissionStatus> | undefined => {
  if (permission === "Camera") {
    return requestCameraPermission();
  } else if (permission === "Photos") {
    return requestPhotosPermission();
  } else if (permission === "CameraPhotos") {
    return requestCameraPhotosPermission();
  } else if (permission === "Microphone") {
    return requestMicrophonePermission();
  } else if (permission === "Phone") {
    return requestPhonePermission();
  } else if (permission === "Location") {
    return requestLocationPermission();
  }
};

export const checkIsGranted = (permission: PermissionType): boolean => {
  const result = checkPermission(permission);
  if (result === PermissionStatus.denied) {
    return false;
  } else if (result === PermissionStatus.granted) {
    return true;
  } else if (result === PermissionStatus.restricted) {
    return false;
  } else if (result === PermissionStatus.limited) {
    return true;
  } else if (result === PermissionStatus.permanentlyDenied) {
    return false;
  } else {
    return false;
  }
};

export const checkRequestPermission = (
  permission: PermissionType
): Promise<boolean> => {
  return new Promise((resolve, reject) => {
    const result = checkPermission(permission);
    console.log("checkRequestPermission-result", result);
    if (result === PermissionStatus.denied) {
      console.log("PermissionStatus.denied");
      showViewDesc(permission);
      const requestResult = requestPermissions(permission);
      if (requestResult) {
        requestResult
          .then((result) => {
            console.log("requestPermissions", result);
            closeViewDesc();
            if (
              result === PermissionStatus.granted ||
              result === PermissionStatus.limited
            ) {
              resolve(true);
            } else {
              if (result === PermissionStatus.permanentlyDenied) {
                gotoAppPermissionSetting();
                resolve(false);
              }
              resolve(false);
            }
          })
          .catch((err) => {
            closeViewDesc();
            reject(err);
          });
      }
    } else if (result === PermissionStatus.granted) {
      console.log("PermissionStatus.granted");
      resolve(true);
    } else if (result === PermissionStatus.restricted) {
      console.log("PermissionStatus.restricted");
      resolve(false);
    } else if (result === PermissionStatus.limited) {
      console.log("PermissionStatus.limited");
      resolve(true);
    } else if (result === PermissionStatus.permanentlyDenied) {
      console.log("PermissionStatus.permanentlyDenied");
      gotoAppPermissionSetting();
      resolve(false);
    } else {
      console.log("PermissionStatus.unknown");
      resolve(false);
    }
  });
};

export type {
  PermissionInfo,
  PermissionResult,
  PermissionStatus,
  PermissionType,
};
```
