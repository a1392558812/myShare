# dropdown 下拉菜单

> 1. popup 内容统一为的插槽渲染，dropdown 不负责任何弹窗内的逻辑，只负责打开弹窗，弹窗内的逻辑自行处理
> 2. 在弹窗打开时，注意锁定滚动条，由于各个平台特性不同，此处无法做统一处理
> 3. DropDown Methods -> open(index): 打开/重新调整弹窗的位置，在滚动时可以调用此方法，及时更新位置
>    DropDown Methods -> close(): 关闭弹窗
>    DropDown Methods -> menuClick(index): 当 ifCustomMenu 为 true 走 `<slot name="menu"/>` 逻辑时，打开对应弹窗需要使用该方法
> 4. 兼容性： 语法较新，较旧编译器可能有问题,可提高 uniapp-cli 版本或 Hbuilderx 版本

- 部分工具函数已经抽取，本人人懒，推荐先看工具函数有无重复代码
  - @/utils/components-tools.ts ---> 04.杂项整理/35.components-tools.md
  - @/hooks/use-comp-relation.ts ---> 04.杂项整理/36.use-comp-relation.md
  - @/utils/type-check.ts ---> 03.杂项整理/14.类型保护工具函数.md
  - @/components/transition/index.vue ---> 07.uniapp 的自定义 Transition 过渡组件.md

## 使用

```html
<template>
  <view>
    <uv-sticky :offset-top="200">
      <custom-dropdown3
        v-model:active-value="dropDownData.activeValue"
        :menu-list="dropDownData.list"
      >
        <template #text="{ item, index, activeValue }">
          {{ item.title }}-{{ index }}-{{ activeValue }}
        </template>

        <template #content>
          <view v-if="dropDownData.activeValue === 'value1'" class="bg-[#fff]">
            <view>value1value1value1value1</view>
          </view>

          <view v-if="dropDownData.activeValue === 'value2'" class="bg-[#fff]">
            <view>value2value2value2value2</view>
            <view>value2value2value2value2</view>
          </view>

          <view v-if="dropDownData.activeValue === 'value3'" class="bg-[#fff]">
            <view>value3value3value3value3</view>
            <view>value3value3value3value3</view>
            <view>value3value3value3value3</view>
          </view>
        </template>
      </custom-dropdown3>
    </uv-sticky>
  </view>
</template>
<script setup lang="ts">
  const dropDownData = reactive({
    activeValue: "",
    list: [
      {
        title: "选项1",
        value: "value1",
      },
      {
        title: "选项2",
        value: "value2",
      },
      {
        title: "选项3",
        value: "value3",
      },
    ],
  });
</script>
```

## index.vue

```html
<template>
  <view class="custom-dropdown" :class="customClass" :style="customStyle">
    <view
      :id="customDropdownMenuId"
      ref="customDropdownMenuRef"
      class="custom-dropdown-menu"
      :style="[{ height: dropDownMenuHeight }, customDropdownMenuWrapStyle]"
    >
      <template v-if="ifCustomMenu">
        <slot name="menu" :active-value="activeValue" />
      </template>

      <template v-else>
        <view
          v-for="(item, index) in menuList"
          :key="index"
          :style="[customTitleStyle, item.titleStyle || {}]"
          class="custom-dropdown-menu-item"
          @tap.stop="menuClick(index)"
        >
          <slot
            name="text"
            :item="item"
            :index="index"
            :active-value="activeValue"
          />
        </view>
      </template>
    </view>
    <view class="custom-dropdown-content">
      <customTransition
        :show="!!activeValue"
        :custom-style="overlayStyle"
        :mode="mode || 'fade'"
        :timing-function="timingFunction || 'ease-out'"
        :duration="duration || 300"
        @click="clickOverlay"
      >
        <template #default>
          <view
            ref="dropDownPopupRef"
            class="custom-drop-down-popup-container"
            :style="[customDropDownPopupContainerStyle, { height: `${contentHeight}px` }]"
            @click.stop="blockClick"
          >
            <view
              :id="`${customDropDownPopupContainerListId}`"
              ref="dropDownPopupListRef"
            >
              <slot name="content" />
            </view>
          </view>
        </template>
      </customTransition>
    </view>
  </view>
</template>

<script setup lang="ts">
  import customTransition from "@/components/transition/index.vue";
  import { getUuid, queryRect, sleep } from "@/utils/components-tools";
  import {
    computed,
    getCurrentInstance,
    nextTick,
    onMounted,
    ref,
    watch,
  } from "vue";

  export interface MenuListItemType {
    title?: string;
    disabled?: boolean;
    value?: string;

    titleStyle?: AnyStyleType;
    customDropDownPopupStyle?: AnyStyleType;
  }

  export interface DropDownPropsType {
    closeOnClickMask?: boolean;
    dropDownMenuHeight?: string;
    mode?: string;
    timingFunction?: string;
    duration?: number;
    ifCustomMenu?: boolean;
    customClass?: string;

    activeValue?: string | undefined;
    menuList: MenuListItemType[];

    customTitleStyle?: AnyStyleType;
    customDropDownPopupStyle?: AnyStyleType;
    customDropDownPopupContainerStyle?: AnyStyleType;
    customDropdownMenuWrapStyle?: AnyStyleType;
    customStyle?: AnyStyleType;
  }

  defineOptions({
    name: "CustomDropdown",
    addGlobalClass: true,
    virtualHost: true,
    styleIsolation: "shared",
  });

  const props = withDefaults(defineProps<DropDownPropsType>(), {
    closeOnClickMask: true,
    duration: 300,
    dropDownMenuHeight: "auto",
    customClass: "",
    mode: "fade",
    ifCustomMenu: false,

    activeValue: undefined,
    menuList: () => [],

    customTitleStyle: () => ({}),
    customDropDownPopupStyle: () => ({}),
    customDropDownPopupContainerStyle: () => ({}),
    customDropdownMenuWrapStyle: () => ({}),
    customStyle: () => ({}),
  });

  const emit = defineEmits(["update:activeValue"]);

  // #ifdef APP-NVUE
  const animation = uni.requireNativePlugin("animation");
  // #endif

  const uuid = getUuid();
  const customDropdownMenuId = `customDropdownMenu${uuid}`;
  const customDropdownMenuRef = ref<HTMLElement>();
  const customDropDownPopupContainerListId = `customDropDownPopupContainerListId${uuid}`;
  const rect = ref<AnyStyleType>({});

  const dropDownPopupRef = ref<HTMLElement>();
  const dropDownPopupListRef = ref<HTMLElement[]>();
  const contentHeight = ref(0);

  const instance = getCurrentInstance();

  const activeValue = ref<string | undefined>(undefined);

  const overlayStyle = computed(() => {
    const height = Number(rect.value.height) || 0;
    let top = Number(rect.value.top) || 0;
    // #ifdef H5
    top += uni.getSystemInfoSync().windowTop;
    // #endif
    const style = {
      position: "fixed",
      top: `${top + height}px`,
      left: 0,
      right: 0,
      bottom: 0,
      "background-color": `rgba(0, 0, 0, 0.5)`,
    };

    const resultStyle = Object.assign(style, props.customDropDownPopupStyle);

    console.log("computed-overlayStyle", resultStyle, top, height);

    return resultStyle;
  });

  const blockClick = () => {};
  const animationFun = (height: number, duration = 300) => {
    // #ifdef APP-NVUE
    const ref = dropDownPopupRef.value;
    animation.transition(ref, {
      styles: {
        height: `${height}px`,
      },
      duration,
    });
    // #endif
  };

  const onOpen = (index: number) => {
    activeValue.value = props.menuList[index].value;
    emit("update:activeValue", activeValue.value);

    nextTick(async () => {
      // #ifndef H5 || MP-WEIXIN
      await sleep(60);
      // #endif
      const res = await queryRect(
        `#${customDropDownPopupContainerListId}`,
        instance!,
        dropDownPopupListRef.value
      );
      // #ifndef APP-NVUE
      contentHeight.value = res.height || 0;
      // #endif
      // #ifdef APP-NVUE
      animationFun(res.height || 0, props.duration);
      // #endif
      console.log("open", res);
    });
  };

  const onClose = () => {
    contentHeight.value = 0;
    // #ifndef APP-NVUE
    contentHeight.value = 0;
    // #endif
    // #ifdef APP-NVUE
    animationFun(0, props.duration);
    // #endif
    activeValue.value = undefined;
    emit("update:activeValue", activeValue.value);
  };

  const clickOverlay = () => {
    if (props.closeOnClickMask) {
      onClose();
    }
  };

  const menuClick = (index: number) => {
    if (props.menuList[index]?.disabled) return;

    queryRect(
      `#${customDropdownMenuId}`,
      instance!,
      customDropdownMenuRef.value
    ).then((res: any) => {
      console.log("menuClick-customDropdownMenuId", res);
      rect.value = res;
    });

    if (!activeValue.value) {
      onOpen(index);
    } else {
      const targetIndex = props.menuList.findIndex(
        (item) => item.value === activeValue.value
      );
      if (targetIndex !== index) {
        onOpen(index);
      } else {
        onClose();
      }
    }
  };

  defineExpose({
    open: onOpen,
    close: onClose,
    menuClick,
  });
</script>

<style scoped lang="scss">
  .custom-dropdown {
    flex: 1;

    .custom-dropdown-menu {
      display: flex;
      flex-direction: row;
      height: 80rpx;
      background-color: #fff;

      .custom-dropdown-menu-item {
        flex: 1;
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
      }
    }

    .custom-dropdown-content {
      .custom-drop-down-popup-container {
        overflow: hidden;
        transition: all 0.15s;
        background-color: #fff;
      }
    }
  }
</style>
```
