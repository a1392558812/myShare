# dropdown 下拉菜单

> 1. popup 内容统一为的插槽渲染，dropdown 不负责任何弹窗内的逻辑，只负责打开弹窗，弹窗内的逻辑自行处理
> 2. 在弹窗打开时，注意锁定滚动条，由于各个平台特性不同，此处无法做统一处理
> 3. DropDown Methods -> open(index): 打开/重新调整弹窗的位置，在滚动时可以调用此方法，及时更新位置
>    DropDown Methods -> close(): 关闭弹窗
>    DropDown Methods -> menuClick(index): 当 ifCustomMenu 为 true 走 `<slot name="menu"/>` 逻辑时，打开对应弹窗需要使用该方法
> 4. 兼容性： 语法较新，较旧编译器可能有问题,可提高 uniapp-cli 版本或 Hbuilderx 版本
> 5. 放弃 v-model 双向绑定打开弹窗：[为什么 uv-popup 等弹窗组件显示不使用 show 属性进行控制，而是使用 ref 控制](https://www.uvui.cn/components/problem.html#%E5%8D%81%E4%B8%80%E3%80%81%E4%B8%BA%E4%BB%80%E4%B9%88uv-popup%E7%AD%89%E5%BC%B9%E7%AA%97%E7%BB%84%E4%BB%B6%E6%98%BE%E7%A4%BA%E4%B8%8D%E4%BD%BF%E7%94%A8show%E5%B1%9E%E6%80%A7%E8%BF%9B%E8%A1%8C%E6%8E%A7%E5%88%B6-%E8%80%8C%E6%98%AF%E4%BD%BF%E7%94%A8ref%E6%8E%A7%E5%88%B6)

## 使用

```html
<template>
  <view>
    <uv-sticky :offset-top="200">
      <custom-dropdown :menu-list="menuList">
        <template #text="{ item, index, activeValue }">
          {{ item.title }}-{{ index }}-{{ activeValue }}
        </template>

        <template #content="{ item }">
          <view v-if="item.value === 'value1'">
            <view>value1value1value1value1</view>
          </view>

          <view v-if="item.value === 'value2'">
            <view>value2value2value2value2</view>
            <view>value2value2value2value2</view>
          </view>

          <view v-if="item.value === 'value3'">
            <view>value3value3value3value3</view>
            <view>value3value3value3value3</view>
            <view>value3value3value3value3</view>
          </view>
        </template>
      </custom-dropdown>

      <view class="h-[200vh] bg-[pink]" />
    </uv-sticky>
  </view>
</template>
<script setup lang="ts">
  const menuList = ref([
    {
      title: "选项1",
      value: "value1",
    },
    {
      title: "选项2",
      value: "value2",
    },
    {
      title: "选项3",
      value: "value3",
    },
  ]);
</script>
```

## index.vue

```html
<template>
  <view class="custom-dropdown" :class="customClass" :style="customStyle">
    <view
      :id="customDropdownMenuId"
      class="custom-dropdown-menu"
      :style="[{ height: dropDownMenuHeight }, customDropdownMenuWrapStyle]"
    >
      <template v-if="ifCustomMenu">
        <slot name="menu" :active-value="activeValue" />
      </template>

      <template v-else>
        <view
          v-for="(item, index) in menuList"
          :key="index"
          :style="[customTitleStyle, item.titleStyle || {}]"
          class="custom-dropdown-menu-item"
          @tap.stop="menuClick(index)"
        >
          <slot
            name="text"
            :item="item"
            :index="index"
            :active-value="activeValue"
          />
        </view>
      </template>
    </view>
    <view class="custom-dropdown-content">
      <customTransition
        :show="!!activeValue"
        :custom-style="overlayStyle"
        :mode="mode || 'fade'"
        :timing-function="timingFunction || 'ease-out'"
        :duration="duration || 300"
        @click="clickOverlay"
      >
        <view
          ref="dropDownPopupRef"
          class="custom-drop-down-popup-container"
          :style="[customDropDownPopupContainerStyle, { height: `${contentHeight}px` }]"
          @click.stop="blockClick"
        >
          <template v-for="(item, index) in menuList" :key="index">
            <view
              v-if="item.value === activeValue"
              :id="`${customDropDownPopupContainerListId}${index}`"
              ref="dropDownPopupListRef"
            >
              <slot name="content" :item="item" :index="index" />
            </view>
          </template>
        </view>
      </customTransition>
    </view>
  </view>
</template>

<script setup lang="ts">
  import customTransition from "@/components/transition/index.vue";
  import { getRect, getUuid, sleep } from "@/utils/components-tools";
  import { computed, getCurrentInstance, nextTick, onMounted, ref } from "vue";

  export interface MenuListItemType {
    title?: string;
    disabled?: boolean;
    value?: string;

    titleStyle?: AnyStyleType;
    customDropDownPopupStyle?: AnyStyleType;
  }

  export interface DropDownPropsType {
    closeOnClickMask?: boolean;
    dropDownMenuHeight?: string;
    mode?: string;
    timingFunction?: string;
    duration?: number;
    ifCustomMenu?: boolean;
    customClass?: string;

    activeValue?: string | undefined;
    menuList: MenuListItemType[];

    customTitleStyle?: AnyStyleType;
    customDropDownPopupStyle?: AnyStyleType;
    customDropDownPopupContainerStyle?: AnyStyleType;
    customDropdownMenuWrapStyle?: AnyStyleType;
    customStyle?: AnyStyleType;
  }

  defineOptions({
    name: "CustomDropdown",
    addGlobalClass: true,
    virtualHost: true,
    styleIsolation: "shared",
  });

  const props = withDefaults(defineProps<DropDownPropsType>(), {
    closeOnClickMask: true,
    duration: 300,
    dropDownMenuHeight: "auto",
    customClass: "",
    mode: "fade",
    ifCustomMenu: false,

    activeValue: undefined,
    menuList: () => [],

    customTitleStyle: () => ({}),
    customDropDownPopupStyle: () => ({}),
    customDropDownPopupContainerStyle: () => ({}),
    customDropdownMenuWrapStyle: () => ({}),
    customStyle: () => ({}),
  });

  // #ifdef APP-NVUE
  const animation = uni.requireNativePlugin("animation");
  const dom = uni.requireNativePlugin("dom");
  // #endif

  const uuid = getUuid();
  const customDropdownMenuId = `customDropdownMenu${uuid}`;
  const customDropDownPopupContainerListId = `customDropDownPopupContainerListId${uuid}`;
  const rect = ref<AnyStyleType>({});

  const dropDownPopupRef = ref<HTMLElement>();
  const dropDownPopupListRef = ref<HTMLElement[]>();
  const contentHeight = ref(0);

  const instance = getCurrentInstance();

  const activeValue = ref<string | undefined>(props.activeValue);

  const overlayStyle = computed(() => {
    const height = Number(rect.value.height) || 0;
    let top = Number(rect.value.top) || 0;
    // #ifdef H5
    top += uni.getSystemInfoSync().windowTop;
    // #endif
    const style = {
      position: "fixed",
      top: `${top + height}px`,
      left: 0,
      right: 0,
      bottom: 0,
      "background-color": `rgba(0, 0, 0, 0.5)`,
    };

    const resultStyle = Object.assign(style, props.customDropDownPopupStyle);

    console.log("computed-overlayStyle", resultStyle, top, height);

    return resultStyle;
  });

  const blockClick = () => {};
  const animationFun = (height: number, duration = 300) => {
    // #ifdef APP-NVUE
    const ref = dropDownPopupRef.value;
    animation.transition(ref, {
      styles: {
        height: `${height}px`,
      },
      duration,
    });
    // #endif
  };

  // 查询内容高度
  const queryRect = (index: number): Promise<UniApp.NodeInfo> => {
    console.log("queryRect", dropDownPopupListRef.value, index);
    // #ifndef APP-NVUE
    return new Promise((resolve) => {
      getRect(
        `#${customDropDownPopupContainerListId}${index}`,
        false,
        instance?.proxy
      ).then((size) => {
        resolve(size);
      });
    });
    // #endif
    // #ifdef APP-NVUE
    // nvue下，使用dom模块查询元素高度
    // 返回一个promise，让调用此方法的主体能使用then回调
    return new Promise((resolve) => {
      dom.getComponentRect(
        dropDownPopupListRef.value![index],
        (res: { size: UniApp.NodeInfo }) => {
          resolve(res.size);
        }
      );
    });
    // #endif
  };

  const onOpen = (index: number) => {
    activeValue.value = props.menuList[index].value;

    nextTick(async () => {
      // #ifndef H5 || MP-WEIXIN
      await sleep(60);
      // #endif
      const res = await queryRect(index);
      // #ifndef APP-NVUE
      contentHeight.value = res.height || 0;
      // #endif
      // #ifdef APP-NVUE
      animationFun(res.height || 0, props.duration);
      // #endif
      console.log("open", res);
    });
  };

  const onClose = () => {
    contentHeight.value = 0;
    // #ifndef APP-NVUE
    contentHeight.value = 0;
    // #endif
    // #ifdef APP-NVUE
    animationFun(0, props.duration);
    // #endif
    activeValue.value = undefined;
  };

  const clickOverlay = () => {
    if (props.closeOnClickMask) {
      onClose();
    }
  };

  const menuClick = (index: number) => {
    if (props.menuList[index]?.disabled) return;

    getRect(`#${customDropdownMenuId}`, false, instance?.proxy).then(
      (res: any) => {
        rect.value = res;
      }
    );

    if (!activeValue.value) {
      onOpen(index);
    } else {
      const targetIndex = props.menuList.findIndex(
        (item) => item.value === activeValue.value
      );
      if (targetIndex !== index) {
        onOpen(index);
      } else {
        onClose();
      }
    }
  };

  defineExpose({
    open: onOpen,
    close: onClose,
    menuClick,
  });
</script>

<style scoped lang="scss">
  .custom-dropdown {
    flex: 1;

    .custom-dropdown-menu {
      /* #ifndef APP-NVUE */
      display: flex;
      flex-direction: row;
      /* #endif */
      height: 80rpx;
      background-color: #fff;

      .custom-dropdown-menu-item {
        flex: 1;
        /* #ifndef APP-NVUE */
        display: flex;
        flex-direction: row;
        /* #endif */
        justify-content: center;
        align-items: center;
      }
    }

    .custom-dropdown-content {
      .custom-drop-down-popup-container {
        /* #ifndef APP-NVUE */
        overflow: hidden;
        transition: all 0.15s;
        /* #endif */
        background-color: #fff;
      }
    }
  }
</style>
```
