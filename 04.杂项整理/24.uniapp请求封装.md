# uniapp è¯·æ±‚å°è£…

```typescript
import { useUserStore } from "@/store/use-user/index";
import { PINIA_TOKEN, PINIA_REFRESH_TOKEN } from "@/utils/static-data";

type RequestConfigType = Omit<UniApp.RequestOptions, "success" | "fail">;

export interface RequestOptions {
  url: UniApp.RequestOptions["url"];
  data?: UniApp.RequestOptions["data"];
  header?: AnyObject;
  method: Lowercase<Exclude<UniApp.RequestOptions["method"], undefined>>;
  hasToken?: boolean;
  setConfig?: (config: RequestConfigType) => RequestConfigType; // è‡ªå®šä¹‰é…ç½®è¯·æ±‚çš„æ‹¦æˆªå™¨
}

export interface ResponseType<T = any> {
  code: string;
  data: T;
  message: string;
}

const commonErrorMessage = "è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•";

const catchToken = () => uni.getStorageSync(PINIA_TOKEN) || "";
const catchRefreshToken = () => uni.getStorageSync(PINIA_REFRESH_TOKEN) || "";

const getErrorNetwork = (
  resolve: (val: any) => void,
  reject: (err: any) => void,
  err: UniApp.GeneralCallbackResult
) => {
  console.log("getErrorNetwork", err);
  if (err.errMsg === "request:fail abort") {
    const errorRes = {
      code: "-1",
      data: err,
      message: "è¯·æ±‚å·²å–æ¶ˆ",
    } as ResponseType;

    console.log("è¯·æ±‚å·²å–æ¶ˆ", errorRes);
    return resolve(errorRes);
  }
  uni.getNetworkType({
    complete: (res) => {
      if (
        res.networkType === "unknown" ||
        res.networkType === "none"
        // || err.errMsg.includes('request:fail')
      ) {
        Object.assign(err, {
          networkType: res.networkType,
        });
        console.log("ç½‘ç»œå¼‚å¸¸-getNetworkType", err);
        return reject(err);
      } else {
        uni.showToast({
          icon: "none",
          title: "è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•",
        });
        return reject(err);
      }
    },
  });
};

export const request = <T>({
  url = "",
  data = {},
  header = {},
  method = "get",
  hasToken = true,
  setConfig = (config) => config,
}: RequestOptions) => {
  let requestTask: UniApp.RequestTask;
  const tokenMap =
    hasToken && catchToken() ? { Authorization: `${catchToken()}` } : {};

  const refreshTokenMap =
    hasToken && catchRefreshToken()
      ? { RefreshAuthorization: `${catchRefreshToken()}` }
      : {};

  const config: RequestConfigType = {
    url: `${import.meta.env.VITE_BASE_REQUEST_URL}${url}`,
    data: data!,
    header: {
      ...tokenMap,
      ...refreshTokenMap,
      ...header,
    },
    method: method.toUpperCase() as Uppercase<RequestOptions["method"]>,
    timeout: 60000,
  };

  Object.assign(config, setConfig!(config));

  console.log("è¯·æ±‚config", config);

  const promise: Promise<ResponseType<T>> = new Promise((resolve, reject) => {
    requestTask = uni.request({
      ...config,
      success: (res) => {
        const requestRes = res.data as ResponseType;
        if (["401"].includes(requestRes.code)) {
          return useUserStore()
            .logout()
            .then(() => {
              uni.showToast({
                title: "ç™»å½•è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•",
                icon: "none",
                duration: 2000,
                mask: true,
              });
              setTimeout(() => {
                uni.reLaunch({
                  url: "/pages/login/index",
                });
              }, 2000);
              return reject(requestRes);
            });
        }

        if (["400"].includes(requestRes.code)) {
          // æƒé™å˜æ›´ï¼Œ
          return useUserStore()
            .getAuthList()
            .then(() => {
              uni.showToast({
                title: "æƒé™å·²å˜æ›´",
                icon: "none",
                duration: 2000,
                mask: true,
              });
              setTimeout(() => {
                uni.reLaunch({
                  url: "/pages/index/index",
                });
              }, 2000);
              return reject(requestRes);
            });
        }

        if (["402"].includes(requestRes.code)) {
          // ç”¨æˆ·ç™»å½•è®¤è¯ä¿¡æ¯å˜æ›´(çŸ­æ—¶é—´ç™»å½•è¿‡æœŸï¼Œé•¿æ—¶é—´æœªæ“ä½œ)
          const userStore = useUserStore();
          return userStore
            .getUserInfo({
              header: {
                Authorization: `${catchToken()}`,
                RefreshAuthorization: `${catchRefreshToken()}`,
              },
            })
            .then((res) => {
              if (res.code === "00000") {
                userStore.setUserInfo(res.data || {});

                const newRequest = request(config);
                requestTask = newRequest.requestTask;

                return newRequest.promise
                  .then((res) => {
                    return resolve(res);
                  })
                  .catch((err) => {
                    return reject(err);
                  });
              } else {
                uni.showToast({
                  title: requestRes.message || "æƒé™å·²å˜æ›´",
                  icon: "none",
                  duration: 2000,
                  mask: true,
                });
                setTimeout(() => {
                  uni.reLaunch({
                    url: "/pages/login/index",
                  });
                }, 2000);
                return reject(res);
              }
            })
            .catch((err) => {
              return reject(err);
            });
        }
        return resolve(requestRes);
      },
      fail: (err) => {
        return getErrorNetwork(resolve, reject, err);
      },
      complete: (result) => {
        console.log("ğŸš€ğŸš€ğŸš€è¯·æ±‚å®Œæˆ:", { config, result });
      },
    });
  });

  return { promise, requestTask: requestTask! };
};

export const upload = <T>(
  options: Omit<UniApp.UploadFileOption, "success" | "fail" | "complete">
) => {
  let requestTask: UniApp.UploadTask;
  const promise: Promise<ResponseType<T>> = new Promise((resolve, reject) => {
    const paramsHeader = options.header || {};

    requestTask = uni.uploadFile({
      ...options,
      url: `${import.meta.env.VITE_BASE_REQUEST_URL}${options.url}`,
      header: {
        Authorization: `${catchToken()}`,
        ...paramsHeader,
      },
      name: options.name || "file",
      success: (res) => {
        const requestRes = JSON.parse(res.data) as ResponseType;
        if (["C0401", "401", "-10001"].includes(requestRes.code)) {
          // æ— æ„Ÿåˆ·æ–°ç™»å½•
          uni.hideLoading();
          return useUserStore()
            .logout()
            .then(() => {
              uni.showToast({
                title: "ç™»å½•è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•",
                icon: "none",
                duration: 2000,
                mask: true,
              });
              setTimeout(() => {
                uni.reLaunch({
                  url: "/pages/login/login-by-account/index",
                });
              }, 2000);
              return reject(requestRes);
            });
        }

        return resolve(requestRes);
      },
      fail: (err) => {
        return getErrorNetwork(resolve, reject, err);
      },
    });
  });
  return { promise, requestTask: requestTask! };
};
```
