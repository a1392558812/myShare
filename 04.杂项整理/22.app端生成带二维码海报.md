# uniapp 的 app 端 生成海报并保存到相册与解码 code

// 生成海报组件

```html
<template>
  <view
    class="fixed left-[-9999rpx] top-[-9999rpx] z-[-1]"
    :prop="options"
    :change:prop="canvas.drawCanvas"
  />
</template>

<script lang="ts">
  import { useDeviceStore } from "@/store/device";
  import { reactive } from "vue";

  interface OptionsType {
    dpr: number;
    id: string;
    type?: "svg" | "png" | "jpg" | "webp";
    success: (base64Str: string) => void;
    fail?: (data: any) => void;
  }

  export default {
    setup() {
      const deviceStore = useDeviceStore();
      const options = reactive<OptionsType>({
        dpr: deviceStore.deviceInfo.devicePixelRatio,
        id: "",
        type: "png",
        success: (base64Str: string) => {
          console.log("base64Str", base64Str);
        },
        fail: (data: any) => {
          console.log("fail", data);
        },
      });

      let successFunc = (base64Str: string) => {
        if (options.success) {
          options.success(base64Str);
        }
      };
      let failFunc = (data: any) => {
        if (options.fail) {
          options.fail(data);
        }
      };

      const drawPicFun = (params: {
        id: string;
        type?: "svg" | "png" | "jpg" | "webp";
        success: (base64Str: string) => void;
        fail?: (data: any) => void;
      }) => {
        Object.assign(options, params);
        successFunc = options.success;
        failFunc = options.fail || (() => {});
      };
      return {
        drawPicFun,
        options,
        successFunc,
        failFunc,
      };
    },
  };
</script>

<script module="canvas" lang="renderjs">
  import { snapdom } from '@zumer/snapdom'

  export default {
    methods: {
      drawCanvas({ id, dpr,type }) {
        console.log('drawCanvas', JSON.stringify(this.options))
        const el = document.getElementById(id)
        snapdom.toBlob(el, { dpr,type }).then((result) => {
          const reader = new FileReader();
          reader.readAsDataURL(result);

          reader.onload = () => {
            this.$ownerInstance.callMethod('successFunc', reader.result)
          };
          reader.onerror = () => {
            this.$ownerInstance.callMethod('failFunc', {message: '图片生成失败'})
          };
          reader.onabort = () => {
            this.$ownerInstance.callMethod('failFunc', {message: '图片生成失败'})
          };
        }).catch((err) => {
          this.$ownerInstance.callMethod('failFunc', {message: '图片生成失败'})
        })
      },
    },
  }
</script>
```

// 使用

```html
<template>
  <view>
    <uv-button @click="onOpenPopup"> 打开popup</uv-button>
    <uv-popup ref="popupRef" mode="center" round="16rpx">
      <view id="post-canvas" class="w-[570rpx] p-[36rpx] rounded-[16rpx]">
        <view class="title-class"> QrCode Title </view>
        <view class="qr-code-class">
          <uv-image
            :src="popupData.qrCodeSrc"
            width="100%"
            height="100%"
            @longpress="onLongPress"
          />
        </view>
        <view class="content-class"> QrCode Content </view>
        <view class="footer-class">
          <uv-button @click="onSavePic"> 下载</uv-button>
        </view>
      </view>
    </uv-popup>
  </view>
</template>

<script setup lang="ts">
  import postCanvas from "@/components/post-canvas/index.vue";
  import { saveBase64Pic, scanBase64Code } from "04.杂项整理/21.plus封装.md";

  const postCanvasRef = ref<InstanceType<typeof postCanvas>>();
  const popupRef = ref<any>(null);

  const popupData = reactive({
    qrCodeSrc: "", // base64 Str
  });

  const onOpenPopup = () => {
    uni.showLoading({
      title: "加载中",
      mask: true,
    });
    setTimeout(() => {
      // 模拟加载二维码
      uni.hideLoading();
      popupData.qrCodeSrc = `data:image/png;base64,xxxxxxxxxxxxxxx`;
      popupRef.value.open();
    }, 3000);
  };

  const onSavePic = () => {
    postCanvasRef.value?.drawPicFun({
      id: "post-canvas",
      success: (base64Str: string) => {
        saveBase64Pic({ base64Str });
      },
      fail: (err) => {
        if (err.message) {
          uni.showToast({
            title: err.message || "下载失败",
            icon: "none",
          });
        }
      },
    });
  };

  const onLongPress = () => {
    scanBase64Code({ base64Str: popupData.qrCodeSrc }).then((res) => {
      console.log("scanBase64Code", res);
    });
  };
</script>
```
