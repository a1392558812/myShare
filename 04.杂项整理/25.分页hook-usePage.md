# 分页 hook-usePage

```typescript
import type { RequestOptions } from "04.杂项整理/24.uniapp请求封装.md";
import type { Reactive, Ref } from "vue";
import { useErrorNetwork } from "@/hooks/error-network.ts";
import { request } from "04.杂项整理/24.uniapp请求封装.md";
import { reactive, ref } from "vue";

export const useGetList = <ListItem>(
  initData: {
    pageData?: Reactive<PageData>;
    list?: Ref<ListItem[]>;
    errorNetworkDataStore?: ReturnType<typeof useErrorNetwork>;
  } = {}
) => {
  const errorNetworkDataStore =
    initData.errorNetworkDataStore || useErrorNetwork();
  const { errorNetworkData, setErrorNetworkData, initErrorNetworkData } =
    errorNetworkDataStore;

  const pageData = reactive<PageData>(
    initData.pageData || {
      pageSize: 20,
      pageNum: 0,
      loading: false,
      total: 0,
      keyword: "",
      status: "loadmore",
    }
  );

  const list = ref(initData.list || []);

  const getList = <T = any>(paramsOptions: {
    isRefresh?: boolean;
    formatListFun?: (list: ListItem[]) => ListItem[];
    options: OverwriteKeys<
      RequestOptions,
      {
        data?: AnyObject;
        method?: RequestOptions["method"];
      }
    >;
  }): Promise<{
    type: "requestSuccess" | "requestFail" | "requestNoMore" | "requestLoading";
    res: any;
  }> => {
    return new Promise((resolve, reject) => {
      if (pageData.loading) {
        return resolve({ type: "requestLoading", res: true });
      }

      if (paramsOptions.isRefresh) {
        Object.assign(pageData, {
          pageNum: 0,
          total: 0,
          status: "loadmore",
        });
      }

      if (pageData.status === "nomore") {
        pageData.loading = false;
        uni.stopPullDownRefresh();
        uni.hideLoading();
        return resolve({ type: "requestNoMore", res: true });
      }

      uni.showLoading({
        title: "加载中...",
        mask: true,
      });

      pageData.loading = true;
      pageData.status = "loading";
      pageData.pageNum = pageData.pageNum + 1;

      request<
        T extends { total: number; records: ListItem[]; [key: string]: any }
          ? T
          : any
      >({
        method: paramsOptions.options.method || "post",
        url: paramsOptions.options.url,
        data: {
          ...(paramsOptions.options.data || {}),
          current: pageData.pageNum,
          size: pageData.pageSize,
        },
      })
        .promise.then((res) => {
          initErrorNetworkData();
          uni.hideLoading();
          uni.stopPullDownRefresh();
          pageData.loading = false;
          pageData.status = "loadmore";

          if (res.code === "00000") {
            pageData.total = res.data.total || 0;

            let result = res.data.records || [];
            result = paramsOptions.formatListFun
              ? paramsOptions.formatListFun(result)
              : result;

            list.value = paramsOptions.isRefresh
              ? result
              : (list.value as ListItem[]).concat(result);
            pageData.status =
              pageData.total > list.value.length ? "loadmore" : "nomore";
            return resolve({ type: "requestSuccess", res });
          } else {
            pageData.pageNum = pageData.pageNum - 1;
            uni.showToast({
              title: res.message || "获取列表失败",
              icon: "none",
            });
            return reject({ type: "requestFail", err: res });
          }
        })
        .catch((err) => {
          if (err.networkType) {
            setErrorNetworkData({
              ifShow: true,
              resetClick: () => {
                getList(paramsOptions);
              },
            });
          }
          uni.hideLoading();
          uni.stopPullDownRefresh();
          pageData.loading = false;
          pageData.status = "loadmore";
          pageData.pageNum = pageData.pageNum - 1;
          uni.showToast({
            title: err.message || "获取列表失败",
            icon: "none",
          });
          return reject({ type: "requestFail", err });
        });
    });
  };

  return {
    pageData,
    list,
    errorNetworkData,
    getList,
    setErrorNetworkData,
    initErrorNetworkData,
  };
};
```
