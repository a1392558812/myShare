# 如何实现一个沙盒

## iframe 沙盒权限控制

// [sandbox 默认全禁用（仅设置 sandbox="" 时，iframe 内无脚本、无表单、无弹窗、不同源、无法访问父窗口）。](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Reference/Elements/iframe#sandbox)

|        权限值        |                           作用                            |                                      风险说明                                      |
| :------------------: | :-------------------------------------------------------: | :--------------------------------------------------------------------------------: |
|    allow-scripts     |             允许 iframe 内执行脚本（最常用）              |                  必须配合 CSP 限制脚本来源，否则可能执行恶意脚本                   |
|  allow-same-origin   | 允许 iframe 页面保留自身源（如同源 Cookie、localStorage） |                高危：不可信内容禁用！若开启，脚本可访问同源敏感数据                |
|     allow-forms      |                       允许表单提交                        |                          需验证表单提交目标，防止数据泄露                          |
|     allow-popups     |                  允许 iframe 打开新窗口                   |                              禁用非必需，防止弹窗钓鱼                              |
| allow-top-navigation |               允许 iframe 跳转父窗口的 URL                | 高危：禁止！仅特殊场景用 allow-top-navigation-by-user-activation（用户触发才允许） |
|   allow-downloads    |                   允许 iframe 触发下载                    |                                    非必需则禁用                                    |
|     allow-modals     |        允许 iframe 打开模态框（alert/confirm 等）         |                                    非必需则禁用                                    |

// [CSP 限制脚本来源，仅允许加载自身域名的脚本/样式，禁止内联脚本/eval，禁止其他资源](https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLIFrameElement/csp)

|     指令     |                     作用                      |                                                     指令值                                                      |
| :----------: | :-------------------------------------------: | :-------------------------------------------------------------------------------------------------------------: |
| default-src  |      所有未单独配置的资源类型的默认策略       |                                     'none' / 'self' / 域名 / 协议 / 通配符                                      |
|  script-src  |                 控制脚本加载                  | 'self' / 'none' / 域名 / 'unsafe-inline'（内联脚本）/ 'unsafe-eval'（eval）/ 'strict-dynamic'（动态脚本信任链） |
|  style-src   |                控制样式表加载                 |                   'self' / 'none' / 域名 / 'unsafe-inline'（内联样式）/ data:（base64 样式）                    |
|   img-src    |                 控制图片加载                  |                 'self' / 'none' / 域名 / data:（base64 图片）/ blob: / https:（仅 HTTPS 图片）                  |
|   font-src   |               控制字体文件加载                |                                         'self' / 'none' / 域名 / data:                                          |
|  media-src   |                控制音视频加载                 |                                     'self' / 'none' / 域名 / blob: / https:                                     |
| connect-src  |           控制 AJAX/fetch/WebSocket           |                             'self' / 'none' / 域名 / wss:（加密 WebSocket）/ https:                             |
|  frame-src   |             控制 iframe 嵌套的源              |                         'self' / 'none' / 可信域名（iframe 沙盒中限制子 iframe 的 src）                         |
|  object-src  |            控制插件（Flash/Java）             |                                         'none'（几乎全场景禁用）/ 域名                                          |
|  worker-src  |         控制 Web Worker/SharedWorker          |                                             'self' / 'none' / 域名                                              |
| manifest-src |             控制 Web App 清单文件             |                                             'self' / 'none' / 域名                                              |
| form-action  | 控制表单提交的目标 URL（iframe 内防数据泄露） |                                           'self' / 'none' / 可信域名                                            |
|     ...      |                      ...                      |                                                       ...                                                       |

```html
<iframe
  src="/"
  sandbox="allow-scripts allow-same-origin"
  contentSecurityPolicy="
    default-src 'none';  
    script-src 'self'
    style-src 'self' 'unsafe-inline';
    connect-src 'self';
    img-src 'self' data:;
    frame-ancestors 'self';
  "
></iframe>
```

## 双向通信

### 父窗口发送消息 → iframe 内执行的代码

`const baseOrigin = "https://xxxx.xxx";`

```javascript
const iframe = document.getElementById("sandbox-iframe");
iframe.addEventListener("load", () => {
  iframe.contentWindow.postMessage(
    {
      type: "INIT_CONFIG", // 消息类型（用于区分不同指令）
      payload: { theme: "dark", userId: "12345" }, // 传递数据
    },
    baseOrigin
  );
});
```

iframe 接收父窗口消息并验证：

```javascript
// iframe 内代码
window.addEventListener("message", (e) => {
  // ....格式与消息类型校验
  console.log("接收父窗口配置：", e.data.payload);
});
```

### iframe 内执行代码发送消息 → 父窗口发送消息

```javascript
// iframe 内代码
document.getElementById("btn").addEventListener("click", () => {
  window.parent.postMessage(
    {
      type: "USER_CLICK",
      payload: { btnId: "submit", timestamp: Date.now() },
    },
    baseOrigin
  );
});
```

父窗口接收 iframe 消息并验证：

```javascript
// 父窗口代码
window.addEventListener("message", (e) => {
  // ....格式与消息类型校验
  console.log("接收 iframe postMessage事件：", e.data.payload);
});
```

## 写个沙盒验证可行性

// code-edit.vue

```html
<template>
  <iframe
    :sandbox="sandbox"
    :contentSecurityPolicy="contentSecurityPolicy"
    :style="customStyle"
    class="border-none outline-none"
    ref="iframeRef"
    width="100%"
    height="100%"
  ></iframe>
</template>
<script setup lang="ts">
  import { ref, useTemplateRef, watch, nextTick, onBeforeMount } from "vue";

  export interface FileItem {
    fileName: string;
    code: (targetFileList: TargetFileItem[]) => string;
    type: string;
    suffix: string;
  }

  export interface TargetFileItem extends FileItem {
    src: string;
    blob: Blob | "";
  }

  const emit = defineEmits<{
    (e: "listenerPostMessageFromIframeToParent", data: MessageEvent): void;
    (e: "listenerPostMessageFromParentToIframe", data: MessageEvent): void;
  }>();

  const props = withDefaults(
    defineProps<{
      baseUrl?: string;
      sandbox?: string;
      contentSecurityPolicy?: string;
      code?: (targetFileList: TargetFileItem[]) => string;
      tagContent?: string;
      htmlStr?: string;
      cssStr?: string;
      imports?: Record<string, string>;

      fileList?: FileItem[];

      customStyle?: Record<string, number | string>;
    }>(),
    {
      baseUrl: window.location.origin,
      sandbox:
        "allow-scripts allow-same-origin allow-forms allow-popups allow-top-navigation allow-downloads allow-modals",
      contentSecurityPolicy: ` default-src 'none'; script-src 'self'; style-src 'self'; img-src 'self' data:; connect-src 'self'; geolocation-src 'self'; media-src 'self';`,
      code: () => "",
      htmlStr: '<div id="app"></div>',
      tagContent: '<script src=""><' + "/script>",
      cssStr: "",
      imports: () => ({}),

      fileList: () => [], // 需注意文件顺序，后置文件能引用前置文件，前置文件不能引用后置文件

      customStyle: () => ({}),
    }
  );

  const iframeRef = useTemplateRef<HTMLIFrameElement>("iframeRef");
  const targetFileList = ref<TargetFileItem[]>([]);

  const destroyBlob = () => {
    targetFileList.value.forEach((item) => {
      if (item.src) {
        URL.revokeObjectURL(item.src);
      }
    });
    targetFileList.value = [];
  };

  const emitMessageFromIframeToParent = (data: {
    type: string;
    payload: Record<string, unknown>;
  }) => {
    if (!data.type) return;
    console.log("emitMessageFromIframeToParent", data);
    iframeRef.value?.contentWindow?.parent?.postMessage(
      {
        type: data.type,
        payload: data.payload,
      },
      props.baseUrl
    );
  };

  const onListenerPostMessageFromIframeToParent = (event: MessageEvent) => {
    if (!event.data.type) return;
    console.log("onListenerPostMessageFromIframeToParent", event.data);
    emit("listenerPostMessageFromIframeToParent", event);
  };

  const emitMessageFromParentToIframe = (data: {
    type: string;
    payload: Record<string, unknown>;
  }) => {
    if (!data.type) return;
    console.log("emitMessageFromParentToIframe", data);
    iframeRef.value?.contentWindow?.postMessage(
      {
        type: data.type,
        payload: data.payload,
      },
      props.baseUrl
    );
  };

  const onListenerPostMessageFromParentToIframe = (event: MessageEvent) => {
    if (!event.data.type) return;
    console.log("onListenerPostMessageFromParentToIframe", event.data);
    emit("listenerPostMessageFromParentToIframe", event);
  };

  const iframeOnLoad = (e: Event) => {
    console.log("iframeOnLoad", e);
    emitMessageFromParentToIframe({
      type: "INIT_FROM_IFRAME_TO_PARENT",
      payload: { code: iframeRef.value?.srcdoc || "" },
    });
    iframeRef.value?.contentWindow?.removeEventListener(
      "message",
      onListenerPostMessageFromParentToIframe
    );
    iframeRef.value?.contentWindow?.addEventListener(
      "message",
      onListenerPostMessageFromParentToIframe
    );
  };

  watch(
    () => [props.fileList, props.code],
    () => {
      nextTick(() => {
        if (!iframeRef.value) return;
        destroyBlob();
        window.removeEventListener(
          "message",
          onListenerPostMessageFromIframeToParent
        );
        window.addEventListener(
          "message",
          onListenerPostMessageFromIframeToParent
        );

        iframeRef.value.removeEventListener("load", iframeOnLoad);

        const list: TargetFileItem[] = [];
        props.fileList.forEach((item) => {
          const blob = new Blob([item.code(list)], {
            type: item.type || "text/javascript;charset=UTF-8",
          });
          const src = URL.createObjectURL(blob);
          list.push({
            ...item,
            blob,
            src,
          });
        });

        targetFileList.value = list;

        const style =
          `<style>html, body{ padding: 0; margin: 0 }` +
          (props.cssStr ? "\n" + props.cssStr : "") +
          `</style>\n`;
        const htmlStr = `${props.htmlStr}\n`;
        const imports =
          '<script type="importmap">\n' +
          `{ "imports": ${JSON.stringify(props.imports)} }` +
          "\n<" +
          "/script>\n";
        const script =
          `<script type="module">${props.code ? props.code(list) : ""}<` +
          `/script>\n`;

        const content = `${style}${props.tagContent}${htmlStr}${imports}${script}`;
        iframeRef.value.srcdoc = content;
        emitMessageFromIframeToParent({
          type: "INIT_FROM_IFRAME_TO_PARENT",
          payload: { code: content },
        });
        iframeRef.value.addEventListener("load", iframeOnLoad);
      });
    },
    {
      immediate: true,
    }
  );

  onBeforeMount(() => {
    iframeRef.value?.contentWindow?.removeEventListener(
      "message",
      onListenerPostMessageFromParentToIframe
    );
    window.removeEventListener(
      "message",
      onListenerPostMessageFromIframeToParent
    );
  });

  defineExpose({
    emitMessageFromParentToIframe,
    emitMessageFromIframeToParent,
  });
</script>
```

// index.vue

```html
<template>
  <div>
    <codeEdit
      :baseUrl="baseUrl"
      :tagContent="tagContent"
      :imports="imports"
      :code="code"
      :fileList="fileList"
    />
  </div>
</template>

<script setup lang="ts">
  import { ref } from "vue";
  import codeEdit from "./components/codeEdit.vue";
  import type { TargetFileItem } from "./components/codeEdit.vue";

  const baseUrl = window.location.origin;
  const imports = ref({
    vue: baseUrl + "/codeEdit/vue@3.4.27/dist/vue.esm-browser.js",
    "vue-demi": baseUrl + "/codeEdit/vue-demi/lib/index.mjs",
    "@vueuse/core": baseUrl + "/codeEdit/@vueuse/core@10.1.0/index.mjs",
    "@vueuse/shared": baseUrl + "/codeEdit/@vueuse/shared@10.1.0/index.mjs",
  });

  const tagContent =
    `<script src="${
      baseUrl + "/codeEdit/@unocss/runtime/preset-icons.global.js"
    }"><` +
    "/script>" +
    `<script src="${baseUrl + "/codeEdit/@unocss/runtime/mini.global.js"}"><` +
    "/script>" +
    `<script src="${baseUrl + "/codeEdit/@unocss/runtime/uno.global.js"}"><` +
    "/script>" +
    `<script>
            window.__unocss = {
              presets: [
                () =>
                  window.__unocss_runtime.presets.presetIcons({
                    scale: 1.2,
                    cdn: 'https://esm.sh/',
                  }),
              ],
            }
        <` +
    "/script>" +
    `<script src="${baseUrl + "/codeEdit/@unocss/runtime/core.global.js"}"><` +
    "/script>";

  const template = `<div>
    <div class="test-box" @click="handleClick">
        点击我 --> num: {{ num }}
    </div>
    <div ref="target" class="bg-[pink] p-[5px]">
        <div>鼠标位置检测</div>
        <div>x: {{ x.toFixed(2) }}</div>
        <div>y: {{ y.toFixed(2) }}</div>
        <div>isOutside: {{ isOutside }}</div>
    </div>
</div>`;

  const fileList = ref([
    {
      fileName: "index.css",
      code: () => `.test-box { width: 200px }`,
      type: "text/css;charset=UTF-8",
      suffix: "css",
    },
    {
      fileName: "index2.js",
      code: () => `console.log('index2.js'); export const aa = 111`,
      type: "text/javascript;charset=UTF-8",
      suffix: "js",
    },
    {
      fileName: "index3.js",
      code: (targetFileList: TargetFileItem[]) => {
        const index2 = targetFileList.find(
          (item) => item.fileName === "index2.js"
        );
        return `import { aa } from '${index2 ? index2.src : ""}'
console.log('index3.js', aa)
export const bb = 222
    `;
      },
      type: "text/javascript;charset=UTF-8",
      suffix: "js",
    },
    {
      fileName: "index.js",
      code: (targetFileList: TargetFileItem[]) => {
        const cssFile = targetFileList.find(
          (item) => item.fileName === "index.css"
        );
        const index3 = targetFileList.find(
          (item) => item.fileName === "index3.js"
        );
        return `import { createApp } from 'vue'
      const linkNode = document.createElement('link')
      linkNode.rel = 'stylesheet'
      linkNode.href = \`${cssFile ? cssFile.src : ""}\`
      document.head.appendChild(linkNode)

import { ref } from 'vue'
import { bb } from '${index3 ? index3.src : ""}'
console.log('bb', bb)
import { useMouseInElement } from '@vueuse/core'
const app = createApp({
  template: '${template.replace(/\n/g, "")}',
  setup() {
    const num = ref(1)
    const target = ref(null)
    const { x, y, isOutside } = useMouseInElement(target)
    const handleClick = () => {
      num.value = num.value + 1
    }
    return {
      handleClick,
      num,
      target,
      x,
      y,
      isOutside
    }
  }
})
console.log('app', app)
app.mount('#app')`;
      },
      type: "text/javascript;charset=UTF-8",
      suffix: "js",
    },
  ]);

  const code = (targetFileList: TargetFileItem[]) => {
    const indexFile = targetFileList.find(
      (item) => item.fileName === "index.js"
    );
    return `
  ${indexFile ? `import '${indexFile.src}'` : ""}
`;
  };
</script>

<style scoped lang="scss"></style>
```
