# dropdown 下拉菜单

> 1. 相较于原版，做了较多修改，默认的文字回显的改为插槽，需手动指定插槽内容来达到效果，需手动处理 active 和 default 的样式，
> 2. popup 内容改为统一的插槽渲染，dropdown 不再负责任何弹窗内的逻辑，只负责打开弹窗，弹窗内的逻辑由子组件自行处理
> 3. 在弹窗打开时，注意锁定滚动条，由于各个平台特性不同，此处无法做统一处理
> 4. DropDown Methods -> init: 初始化弹窗的位置，在滚动时可以调用此方法，及时更新位置

- 部分工具函数已经抽取，本人人懒，推荐先看工具函数有无重复代码
  - @/utils/components-tools.ts ---> 04.杂项整理/35.components-tools.md
  - @/hooks/use-comp-relation.ts ---> 04.杂项整理/36.use-comp-relation.md
  - @/utils/type-check.ts ---> 03.杂项整理/14.类型保护工具函数.md
  - @/components/transition/index.vue ---> 07.uniapp 的自定义 Transition 过渡组件.md

## 使用

```html
<template>
  <customDropdown
    ref="dropDownRef"
    sign="dropDown114514"
    :default-value="[0, 0, 0]"
    @handle-click="onSelectMenu"
  >
    <customDropdownItem
      v-for="(item, index) in dropDownData.child"
      :key="index"
      :name="index"
      :label="dropDownData.child[index].child[dropDownData.child[index].activeIndex].label"
      :value="dropDownData.child[index].child[dropDownData.child[index].activeIndex].value"
    >
      <template #text="{ label, active, isDroped, value }">
        <view> {{ label }}-{{ active }}-{{ isDroped }}-{{ value }} </view>
      </template>
    </customDropdownItem>
  </customDropdown>
  <customDropdownPopup
    ref="dropDownPopupRef"
    sign="dropDown114514"
    :current-drop-item="dropDownData.child[dropDownData.activeIndex]"
    @popup-change="onPopupChange"
  >
    <view class="max-h-[600rpx] min-h-[100rpx] bg-[#fff]">
      {{ dropDownData.activeIndex }}
    </view>
  </customDropdownPopup>
</template>

<script setup lang="ts">
  const dropDownRef = ref<any>(null);
  const dropDownPopupRef = ref<any>(null);
  const dropDownData = reactive({
    child: [
      {
        activeIndex: 0,
        child: [
          {
            label: "全省1",
            value: "省value1",
          },
          {
            label: "全省2",
            value: "省value2",
          },
          {
            label: "全省3",
            value: "省value3",
          },
        ],
      },
      {
        activeIndex: 0,
        child: [
          {
            label: "全市1",
            value: "市value1",
          },
          {
            label: "全市2",
            value: "市value2",
          },
          {
            label: "全市3",
            value: "市value3",
          },
        ],
      },
    ],
    activeIndex: 0,
  });

  const onSelectMenu = (e: { name: number; active: number; type: number }) => {
    console.log("onSelectMenu", e);
    dropDownData.activeIndex = e.name;
  };

  const onPopupChange = (e: any) => {
    console.log("onPopupChange", e);
  };
</script>
```

## index.vue

```html
<template>
  <view
    :id="dropDownId"
    ref="dropDownRef"
    class="custom-drop-down"
    :style="[customStyle]"
  >
    <slot />
  </view>
</template>

<script setup lang="ts">
  import { getRect, getUuid } from "@/utils/components-tools";
  import { getCurrentInstance, nextTick, onMounted, ref } from "vue";

  export interface DropDownPropsType {
    sign: string;
    defaultValue?: Array<string | number>;
    customStyle?: AnyStyleType;
  }

  defineOptions({
    name: "CustomDropDown",
    addGlobalClass: true,
    virtualHost: true,
    styleIsolation: "shared",
  });

  const props = withDefaults(defineProps<DropDownPropsType>(), {
    sign: "CUSTOMDROPDOWN",
    defaultValue: () => [0, "0", "all"],
    customStyle: () => ({}),
  });
  const emit = defineEmits(["handleClick"]);
  // #ifdef APP-NVUE
  const dom = uni.requireNativePlugin("dom");
  // #endif

  const uuid = getUuid();
  const dropDownRef = ref<HTMLElement>();
  const instance = getCurrentInstance();
  const dropDownId = `dropDownId${uuid}`;
  const clickHandler = (data: any) => {
    emit("handleClick", data);
  };

  const queryRect = () => {
    // #ifndef APP-NVUE
    // 组件内部一般用this.$uvGetRect，对外的为getRect，二者功能一致，名称不同
    return new Promise((resolve) => {
      getRect(`#${dropDownId}`, false, instance?.proxy).then((size) => {
        resolve(size);
      });
    });
    // #endif
    // #ifdef APP-NVUE
    // nvue下，使用dom模块查询元素高度
    // 返回一个promise，让调用此方法的主体能使用then回调
    return new Promise((resolve) => {
      dom.getComponentRect(dropDownRef.value, (res: any) => {
        res.size.top = res.size.top <= 0 ? 0 : res.size.top;
        resolve(res.size);
      });
    });
    // #endif
  };

  const init = () => {
    uni.$emit(`${props.sign}_CLICKMENU`, {
      show: false,
    });
    nextTick(async () => {
      const rect = await queryRect();
      uni.$emit(`${props.sign}_GETRECT`, rect);
    });
  };

  onMounted(() => {
    init();
  });

  defineExpose({
    defaultValue: props.defaultValue,
    sign: props.sign,
    clickHandler,
    key: "123",
    init,
  });
</script>

<style scoped lang="scss">
  .custom-drop-down {
    // #ifndef APP-NVUE
    display: flex;
    // #endif
    flex-direction: row;
    justify-content: space-between;
    background-color: #fff;
    border-bottom: 1px solid #dadbde;
    height: 80rpx;
  }
</style>
```

## item.vue

```html
<template>
  <view class="custom-drop-down-item" @click="clickHandler">
    <slot
      name="text"
      :label="label"
      :active="active"
      :is-droped="isDroped"
      :value="value"
    />
  </view>
</template>

<script setup lang="ts">
  import { getParent, getUuid } from "@/utils/components-tools";
  import {
    getCurrentInstance,
    nextTick,
    onBeforeMount,
    reactive,
    ref,
    watch,
  } from "vue";

  export interface DropDownItemPropsType {
    name?: string | number;
    label?: string;
    value?: string | number | null;
    isDrop?: boolean;
  }

  defineOptions({
    name: "CustomDropDownItem",
    addGlobalClass: true,
    virtualHost: true,
    styleIsolation: "shared",
  });

  const props = withDefaults(defineProps<DropDownItemPropsType>(), {
    name: "",
    label: "",
    value: "",
    isDrop: false,
  });

  const emit = defineEmits(["handleClick"]);

  const parentData = reactive<{
    defaultValue: (string | number)[];
    sign: string;
    clickHandler: AnyFunction;
  }>({
    defaultValue: [0, "0", "all"],
    sign: "",
    clickHandler: () => {},
  });

  const instance = getCurrentInstance();
  const active = ref(false);
  const isDroped = ref(false);
  const elId = ref("");

  const init = () => {
    elId.value = getUuid();
    const targetParent = getParent("CustomDropDown", instance?.proxy);
    if (!targetParent) {
      console.error("drop-down必须搭配drop-down-item组件使用");
    }

    console.log("targetParent", targetParent);

    Object.keys(parentData).forEach((key) => {
      const parentDataKey = key as string as keyof typeof parentData;
      parentData[parentDataKey] = (targetParent as any)[parentDataKey];
    });

    uni.$on("HANDLE_DROPDOWN_ONE", (id) => {
      if (isDroped.value && `${elId.value}` !== `${id}`) {
        isDroped.value = false;
      }
    });
    uni.$on(`${parentData.sign}_CLOSEPOPUP`, async () => {
      if (isDroped.value) {
        isDroped.value = false;
      }
    });
  };

  const clickHandler = async () => {
    let data = {};
    uni.$emit("HANDLE_DROPDOWN_ONE", elId.value);
    isDroped.value = !isDroped.value;
    data = {
      name: props.name,
      active: isDroped.value,
    };

    parentData.clickHandler(data);
    emit("handleClick", data);
    console.log("clickHandler", parentData.sign);
    uni.$emit(`${parentData.sign}_CLICKMENU`, {
      show: isDroped.value,
    });
  };

  onBeforeMount(() => {
    init();
  });

  watch(
    () => props.isDrop,
    (newVal) => {
      isDroped.value = newVal;
    },
    {
      immediate: true,
    }
  );

  watch(
    () => props.value,
    (newVal) => {
      nextTick(() => {
        active.value = !parentData.defaultValue.includes(newVal || "");
      });
    },
    {
      immediate: true,
    }
  );
</script>

<style scoped lang="scss">
  .custom-drop-down-item {
    // #ifndef APP-NVUE
    display: flex;
    // #endif
    flex-direction: row;
    align-items: center;
    padding: 20rpx;
  }
</style>
```

## popup.vue

```html
<template>
  <view class="custom-drop-down-popup">
    <customTransition
      :show="show"
      mode="fade"
      :duration="300"
      :custom-style="overlayStyle"
      @click="clickOverlay"
    >
      <view
        ref="dropDownPopupRef"
        class="custom-drop-down-popup-container"
        :style="{ height: `${contentHeight}px` }"
        @click.stop="blockClick"
      >
        <view
          :id="customDropDownPopupContainerListId"
          ref="dropDownPopupListRef"
          class="custom-drop-down-popup-container-list"
        >
          <slot />
        </view>
      </view>
    </customTransition>
  </view>
</template>

<script setup lang="ts">
  import customTransition from "@/components/transition/index.vue";
  import { getRect, getUuid, sleep } from "@/utils/components-tools";
  import {
    computed,
    getCurrentInstance,
    nextTick,
    onBeforeMount,
    ref,
    watch,
  } from "vue";

  const props = withDefaults(defineProps<DropDownPopupPropsType>(), {
    sign: "UVDROPDOWN",
    zIndex: 999,
    opacity: 0.5,
    clickOverlayOnClose: true,
    currentDropItem: () => ({
      activeIndex: 0,
      child: [],
    }),
    customStyle: () => ({}),
  });
  const emit = defineEmits(["popupChange"]);

  // #ifdef APP-NVUE
  const animation = uni.requireNativePlugin("animation");
  const dom = uni.requireNativePlugin("dom");
  // #endif

  export interface DropDownPopupPropsType {
    sign?: string | number;
    zIndex?: number;
    opacity?: number;
    clickOverlayOnClose?: boolean;
    currentDropItem?: {
      activeIndex: number;
      child: any[];
    };
    customStyle?: AnyStyleType;
  }

  const uuid = getUuid();
  const customDropDownPopupContainerListId = `customDropDownPopupContainerListId${uuid}`;
  const show = ref(false);
  const rect = ref<AnyStyleType>({});
  const contentHeight = ref(0);
  const instance = getCurrentInstance();

  const dropDownPopupListRef = ref<HTMLElement>();
  const dropDownPopupRef = ref<HTMLElement>();

  const overlayStyle = computed(() => {
    const height = Number(rect.value.height) || 0;
    let top = Number(rect.value.top) || 0;
    // #ifdef H5
    top += uni.getSystemInfoSync().windowTop;
    // #endif
    const style = {
      position: "fixed",
      top: `${top + height}px`,
      left: 0,
      right: 0,
      zIndex: props.zIndex,
      bottom: 0,
      "background-color": `rgba(0, 0, 0, ${props.opacity})`,
    };

    const resultStyle = Object.assign(style, props.customStyle);

    console.log("overlayStyle??????", resultStyle, top, height);

    return resultStyle;
  });

  // 查询内容高度
  const queryRect = (): Promise<UniApp.NodeInfo> => {
    // #ifndef APP-NVUE
    // 组件内部一般用this.$uvGetRect，对外的为getRect，二者功能一致，名称不同
    return new Promise((resolve) => {
      getRect(
        `#${customDropDownPopupContainerListId}`,
        false,
        instance?.proxy
      ).then((size) => {
        resolve(size);
      });
    });
    // #endif
    // #ifdef APP-NVUE
    // nvue下，使用dom模块查询元素高度
    // 返回一个promise，让调用此方法的主体能使用then回调
    return new Promise((resolve) => {
      dom.getComponentRect(
        dropDownPopupListRef.value,
        (res: { size: UniApp.NodeInfo }) => {
          resolve(res.size);
        }
      );
    });
    // #endif
  };

  const animationFun = (height: number, duration = 200) => {
    // #ifdef APP-NVUE
    const ref = dropDownPopupRef.value;
    animation.transition(ref, {
      styles: {
        height: `${height}px`,
      },
      duration,
    });
    // #endif
  };

  const open = () => {
    show.value = true;
    nextTick(async () => {
      // #ifndef H5 || MP-WEIXIN
      await sleep(60);
      // #endif
      const res = await queryRect();
      // #ifndef APP-NVUE
      contentHeight.value = res.height || 0;
      // #endif
      // #ifdef APP-NVUE
      animationFun(res.height || 0);
      // #endif
      console.log("open", res);
      emit("popupChange", { show: true });
    });
  };

  const close = () => {
    if (!show.value) return;
    contentHeight.value = 0;
    // #ifndef APP-NVUE
    contentHeight.value = 0;
    // #endif
    // #ifdef APP-NVUE
    animationFun(0);
    // #endif
    show.value = false;
    uni.$emit(`${props.sign}_CLOSEPOPUP`);
    emit("popupChange", { show: false });
  };

  const clickOverlay = () => {
    if (props.clickOverlayOnClose) {
      close();
    }
  };

  const init = () => {
    uni.$off(`${props.sign}_GETRECT`);
    uni.$on(`${props.sign}_GETRECT`, (rectRes) => {
      console.log("_GETRECT", rectRes);
      rect.value = rectRes;
    });
    uni.$off(`${props.sign}_CLICKMENU`);
    uni.$on(`${props.sign}_CLICKMENU`, async (res) => {
      console.log("_CLICKMENU", res);
      if (res.show) {
        open();
      } else {
        close();
      }
    });
  };
  const blockClick = () => {};

  onBeforeMount(() => {
    init();
  });
</script>

<style scoped lang="scss">
  .custom-drop-down-popup-container {
    /* #ifndef APP-NVUE */
    overflow: hidden;
    transition: all 0.15s;
    /* #endif */
    background-color: #fff;
  }
</style>
```
