# è¯·æ±‚çš„ç¼“å­˜ä¸é‡å¤è¯·æ±‚è¿‡æ»¤

> 1. é»˜è®¤åªå¤„ç†getè¯·æ±‚
>
> 2. é»˜è®¤url data methodsç›¸åŒçš„è¯·æ±‚ï¼Œæ‰ä¸ºåŒä¸€è¯·æ±‚
> 3. é»˜è®¤è¯·æ±‚ç¼“å­˜1åˆ†é’Ÿ

> åˆ¤æ–­è¯·æ±‚æ˜¯å¦åœ¨ç¼“å­˜ä¸­ ifCache.js
```js
import md5 from 'md5'
import storage from './storage.js'
// åˆ¤æ–­æ˜¯å¦æ˜¯ç¼“å­˜ä¸­çš„è¯·æ±‚
export default ({url, data, method}) => {
  if (method === 'GET') {
    const key = md5(url + JSON.stringify(data) + (method || '')) // ç”Ÿæˆç¼“å­˜çš„key
    const cacheData = storage.get(key); // è¯»å–keyå¯¹åº”çš„value
    if (cacheData) { // åˆ¤æ–­storageæ˜¯å¦æœ‰è¯¥keyå¯¹åº”çš„å€¼
      if (Date.now() <= cacheData.exppries) { // åœ¨ç¼“å­˜æ—¶é—´ä¸­
        return {cache: true,data: cacheData.data}
      } else { // æœ‰ç¼“å­˜è¯·æ±‚ï¼Œåªæ˜¯è¶…æ—¶äº†,é‚£ä¹ˆåˆ æ‰è¿™ä¸ªç¼“å­˜ï¼Œé‡æ–°è¯·æ±‚ï¼Œåœ¨å“åº”æ‹¦æˆªä¸­é‡æ–°ç¼“å­˜
        storage.clear(key)
        return {cache: false,data: {}}
      }
    } else {
      return {cache: false,data: {}}
    }
  } else {
    return {cache: false,data: {}}
  }
}

```

> åˆ¤æ–­æ˜¯å¦éœ€è¦ç¼“å­˜ cache.js

```js
import md5 from 'md5'
import storage from './storage.js'
// ç¼“å­˜è¯·æ±‚
export default ({url ,data, method, resData, cacheTime}) => {
  if (resData && url && method && method === 'GET') {
    storage.set(md5(url + data + (method || '')), {
      data: resData, // å“åº”ä½“æ•°æ®
      exppries: Date.now() + cacheTime, // è®¾ç½®è¿‡æœŸæ—¶é—´
    });
  }
}

```

> åœ¨è¯·æ±‚æ‹¦æˆªå™¨ä¸å“åº”æ‹¦æˆªå™¨ä¸­åº”ç”¨

```js
import axios from 'axios'
import cache from './cache'
import ifCache from './ifCache'

axios.interceptors.request.use((config) => {
  const source = axios.CancelToken.source();
  config.cancelToken = source.token;
  const result = ifCache({
    url: config.url,
    data: config.data,
    method: config.method
  })
  if (result.cache) {
    source.cancel(JSON.stringify({
      type: 'cancel',
      data: ifCache.data,
    }));
  }
  return config
})

axios.interceptors.response.use((response) => {
  if (response.config.method === 'get') {
    const {url,data,method} = response.config
    const resData = response.data
    cache({url ,data, method, resData, cacheTime: 1 * 60 * 1000})
  }
  return response
})
export default axios
```

> ç‰¹æ®Šè¯´æ˜ï¼ˆä¸¾ä¸ªæ —å­ğŸŒ°ï¼‰
>
> å–æ¶ˆçš„è¯·æ±‚åœ¨catchå—ä¸­ï¼Œå¦‚æœæˆ‘ä»¬å°è£…axiosï¼Œéœ€è¦é¢å¤–ç”¨promiseå¤„ç†åŒ…è£…å–æ¶ˆçš„è¯·æ±‚ï¼Œè®²ä¹‹resolve()æ‰

```js
// ä¸¾ä¾‹ğŸŒ°
export default () => {
  return new Promise((resolve, reject) => {
    axios.get('/user/12345')
    .then(res => {
      resolve(res)
    })
    .catch((error) => {
      if (axios.isCancel(error)) { // æ˜¯å¦æ˜¯å–æ¶ˆçš„è¯·æ±‚
        console.log('Request canceledãƒ½(â—-`Ğ”Â´-)ãƒ', error);
        const cancleData = JSON.parse(error.message);
        if (cancleData.type === 'cancel') { // æ˜¯å¦æ˜¯æˆ‘ä»¬å®šä¹‰çš„ç¼“å­˜å–æ¶ˆçš„è¯·æ±‚
          return resolve(cancleData);
        } else {
          return reject(cancleData);
        }
      } else {
        // å¤„ç†é”™è¯¯
        console.log('Request errorâ”­â”®ï¹â”­â”®', error);
        reject(error)
      }
    });
  })
}
```

