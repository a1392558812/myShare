if(Array.prototype.find||(Array.prototype.find=function(t){if(null===this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof t)throw new TypeError("predicate must be a function");for(var e,i=Object(this),n=i.length>>>0,r=arguments[1],o=0;o<n;o++)if(e=i[o],t.call(r,e,o,i))return e}),window&&"function"!=typeof window.CustomEvent){let t=function(t,e){e=e||{bubbles:!1,cancelable:!1,detail:void 0};var i=document.createEvent("CustomEvent");return i.initCustomEvent(t,e.bubbles,e.cancelable,e.detail),i};void 0!==window.Event&&(t.prototype=window.Event.prototype),window.CustomEvent=t}class t{constructor(t){this.tribute=t,this.tribute.events=this}static keys(){return[{key:9,value:"TAB"},{key:8,value:"DELETE"},{key:13,value:"ENTER"},{key:27,value:"ESCAPE"},{key:32,value:"SPACE"},{key:38,value:"UP"},{key:40,value:"DOWN"}]}bind(t){t.boundKeydown=this.keydown.bind(t,this),t.boundKeyup=this.keyup.bind(t,this),t.boundInput=this.input.bind(t,this),t.addEventListener("keydown",t.boundKeydown,!1),t.addEventListener("keyup",t.boundKeyup,!1),t.addEventListener("input",t.boundInput,!1)}unbind(t){t.removeEventListener("keydown",t.boundKeydown,!1),t.removeEventListener("keyup",t.boundKeyup,!1),t.removeEventListener("input",t.boundInput,!1),delete t.boundKeydown,delete t.boundKeyup,delete t.boundInput}keydown(e,i){e.shouldDeactivate(i)&&(e.tribute.isActive=!1,e.tribute.hideMenu());let n=this;e.commandEvent=!1,t.keys().forEach((t=>{t.key===i.keyCode&&(e.commandEvent=!0,e.callbacks()[t.value.toLowerCase()](i,n))}))}input(t,e){t.inputEvent=!0,t.keyup.call(this,t,e)}click(t,e){let i=t.tribute;if(i.menu&&i.menu.contains(e.target)){let t=e.target;for(e.preventDefault(),e.stopPropagation();"li"!==t.nodeName.toLowerCase();)if(t=t.parentNode,!t||t===i.menu)throw new Error("cannot find the <li> container for the click");i.selectItemAtIndex(t.getAttribute("data-index"),e),i.hideMenu()}else i.current.element&&!i.current.externalTrigger&&(i.current.externalTrigger=!1,setTimeout((()=>i.hideMenu())))}keyup(t,e){if(t.inputEvent&&(t.inputEvent=!1),t.updateSelection(this),27!==e.keyCode){if(!t.tribute.allowSpaces&&t.tribute.hasTrailingSpace)return t.tribute.hasTrailingSpace=!1,t.commandEvent=!0,void t.callbacks().space(e,this);if(!t.tribute.isActive)if(t.tribute.autocompleteMode)t.callbacks().triggerChar(e,this,"");else{let i=t.getKeyCode(t,this,e);if(isNaN(i)||!i)return;let n=t.tribute.triggers().find((t=>t.charCodeAt(0)===i));void 0!==n&&t.callbacks().triggerChar(e,this,n)}t.tribute.current.mentionText.length<t.tribute.current.collection.menuShowMinLength||((t.tribute.current.trigger||t.tribute.autocompleteMode)&&!1===t.commandEvent||t.tribute.isActive&&8===e.keyCode)&&t.tribute.showMenuFor(this,!0)}}shouldDeactivate(e){if(!this.tribute.isActive)return!1;if(0===this.tribute.current.mentionText.length){let i=!1;return t.keys().forEach((t=>{e.keyCode===t.key&&(i=!0)})),!i}return!1}getKeyCode(t,e,i){let n=t.tribute,r=n.range.getTriggerInfo(!1,n.hasTrailingSpace,!0,n.allowSpaces,n.autocompleteMode);return!!r&&r.mentionTriggerChar.charCodeAt(0)}updateSelection(t){this.tribute.current.element=t;let e=this.tribute.range.getTriggerInfo(!1,this.tribute.hasTrailingSpace,!0,this.tribute.allowSpaces,this.tribute.autocompleteMode);e&&(this.tribute.current.selectedPath=e.mentionSelectedPath,this.tribute.current.mentionText=e.mentionText,this.tribute.current.selectedOffset=e.mentionSelectedOffset)}callbacks(){return{triggerChar:(t,e,i)=>{let n=this.tribute;n.current.trigger=i;let r=n.collection.find((t=>t.trigger===i));n.current.collection=r,n.current.mentionText.length>=n.current.collection.menuShowMinLength&&n.inputEvent&&n.showMenuFor(e,!0)},enter:(t,e)=>{this.tribute.isActive&&this.tribute.current.filteredItems&&(t.preventDefault(),t.stopPropagation(),setTimeout((()=>{this.tribute.selectItemAtIndex(this.tribute.menuSelected,t),this.tribute.hideMenu()}),0))},escape:(t,e)=>{this.tribute.isActive&&(t.preventDefault(),t.stopPropagation(),this.tribute.isActive=!1,this.tribute.hideMenu())},tab:(t,e)=>{this.callbacks().enter(t,e)},space:(t,e)=>{this.tribute.isActive&&(this.tribute.spaceSelectsMatch?this.callbacks().enter(t,e):this.tribute.allowSpaces||(t.stopPropagation(),setTimeout((()=>{this.tribute.hideMenu(),this.tribute.isActive=!1}),0)))},up:(t,e)=>{if(this.tribute.isActive&&this.tribute.current.filteredItems){t.preventDefault(),t.stopPropagation();let e=this.tribute.current.filteredItems.length,i=this.tribute.menuSelected;e>i&&i>0?(this.tribute.menuSelected--,this.setActiveLi()):0===i&&(this.tribute.menuSelected=e-1,this.setActiveLi(),this.tribute.menu.scrollTop=this.tribute.menu.scrollHeight)}},down:(t,e)=>{if(this.tribute.isActive&&this.tribute.current.filteredItems){t.preventDefault(),t.stopPropagation();let e=this.tribute.current.filteredItems.length-1,i=this.tribute.menuSelected;e>i?(this.tribute.menuSelected++,this.setActiveLi()):e===i&&(this.tribute.menuSelected=0,this.setActiveLi(),this.tribute.menu.scrollTop=0)}},delete:(t,e)=>{this.tribute.isActive&&this.tribute.current.mentionText.length<1?this.tribute.hideMenu():this.tribute.isActive&&this.tribute.showMenuFor(e)}}}setActiveLi(t){let e=this.tribute.menu.querySelectorAll("li"),i=e.length>>>0;t&&(this.tribute.menuSelected=parseInt(t));for(let n=0;n<i;n++){let t=e[n];if(n===this.tribute.menuSelected){t.classList.add(this.tribute.current.collection.selectClass);let e=t.getBoundingClientRect(),i=this.tribute.menu.getBoundingClientRect();if(e.bottom>i.bottom){let t=e.bottom-i.bottom;this.tribute.menu.scrollTop+=t}else if(e.top<i.top){let t=i.top-e.top;this.tribute.menu.scrollTop-=t}}else t.classList.remove(this.tribute.current.collection.selectClass)}}getFullHeight(t,e){let i=t.getBoundingClientRect().height;if(e){let e=t.currentStyle||window.getComputedStyle(t);return i+parseFloat(e.marginTop)+parseFloat(e.marginBottom)}return i}}class e{constructor(t){this.tribute=t,this.tribute.menuEvents=this,this.menu=this.tribute.menu}bind(t){this.menuClickEvent=this.tribute.events.click.bind(null,this),this.menuContainerScrollEvent=this.debounce((()=>{this.tribute.isActive&&this.tribute.showMenuFor(this.tribute.current.element,!1)}),300,!1),this.windowResizeEvent=this.debounce((()=>{this.tribute.isActive&&this.tribute.range.positionMenuAtCaret(!0)}),300,!1),this.tribute.range.getDocument().addEventListener("MSPointerDown",this.menuClickEvent,!1),this.tribute.range.getDocument().addEventListener("mousedown",this.menuClickEvent,!1),window.addEventListener("resize",this.windowResizeEvent),this.menuContainer?this.menuContainer.addEventListener("scroll",this.menuContainerScrollEvent,!1):window.addEventListener("scroll",this.menuContainerScrollEvent)}unbind(t){this.tribute.range.getDocument().removeEventListener("mousedown",this.menuClickEvent,!1),this.tribute.range.getDocument().removeEventListener("MSPointerDown",this.menuClickEvent,!1),window.removeEventListener("resize",this.windowResizeEvent),this.menuContainer?this.menuContainer.removeEventListener("scroll",this.menuContainerScrollEvent,!1):window.removeEventListener("scroll",this.menuContainerScrollEvent)}debounce(t,e,i){var n;return()=>{var r=this,o=arguments,s=i&&!n;clearTimeout(n),n=setTimeout((()=>{n=null,i||t.apply(r,o)}),e),s&&t.apply(r,o)}}}class i{constructor(t){this.tribute=t,this.tribute.range=this}getDocument(){let t;return this.tribute.current.collection&&(t=this.tribute.current.collection.iframe),t?t.contentWindow.document:document}positionMenuAtCaret(t){let e,i=this.tribute.current,n=this.getTriggerInfo(!1,this.tribute.hasTrailingSpace,!0,this.tribute.allowSpaces,this.tribute.autocompleteMode);if(void 0!==n){if(!this.tribute.positionMenu)return void(this.tribute.menu.style.cssText="display: block;");e=this.isContentEditable(i.element)?this.getContentEditableCaretPosition(n.mentionPosition):this.getTextAreaOrInputUnderlinePosition(this.tribute.current.element,n.mentionPosition),this.tribute.menu.style.cssText=`top: ${e.top}px;\n                                     left: ${e.left}px;\n                                     right: ${e.right}px;\n                                     bottom: ${e.bottom}px;\n                                     position: absolute;\n                                     display: block;`,"auto"===e.left&&(this.tribute.menu.style.left="auto"),"auto"===e.top&&(this.tribute.menu.style.top="auto"),t&&this.scrollIntoView(),window.setTimeout((()=>{let i={width:this.tribute.menu.offsetWidth,height:this.tribute.menu.offsetHeight},n=this.isMenuOffScreen(e,i),r=window.innerWidth>i.width&&(n.left||n.right),o=window.innerHeight>i.height&&(n.top||n.bottom);(r||o)&&(this.tribute.menu.style.cssText="display: none",this.positionMenuAtCaret(t))}),0)}else this.tribute.menu.style.cssText="display: none"}get menuContainerIsBody(){return this.tribute.menuContainer===document.body||!this.tribute.menuContainer}selectElement(t,e,i){let n,r=t;if(e)for(var o=0;o<e.length;o++){if(r=r.childNodes[e[o]],void 0===r)return;for(;r.length<i;)i-=r.length,r=r.nextSibling;0!==r.childNodes.length||r.length||(r=r.previousSibling)}let s=this.getWindowSelection();n=this.getDocument().createRange(),n.setStart(r,i),n.setEnd(r,i),n.collapse(!0);try{s.removeAllRanges()}catch(l){}s.addRange(n),t.focus()}replaceTriggerText(t,e,i,n,r){let o=this.getTriggerInfo(!0,i,e,this.tribute.allowSpaces,this.tribute.autocompleteMode);if(void 0!==o){let e=this.tribute.current,i=new CustomEvent("tribute-replaced",{detail:{item:r,instance:e,context:o,event:n}});if(this.isContentEditable(e.element)){t+="string"==typeof this.tribute.replaceTextSuffix?this.tribute.replaceTextSuffix:" ";let e=o.mentionPosition+o.mentionText.length;this.tribute.autocompleteMode||(e+=o.mentionTriggerChar.length),this.pasteHtml(t,o.mentionPosition,e)}else{let e=this.tribute.current.element,i="string"==typeof this.tribute.replaceTextSuffix?this.tribute.replaceTextSuffix:" ";t+=i;let n=o.mentionPosition,r=o.mentionPosition+o.mentionText.length+i.length;this.tribute.autocompleteMode||(r+=o.mentionTriggerChar.length-1),e.value=e.value.substring(0,n)+t+e.value.substring(r,e.value.length),e.selectionStart=n+t.length,e.selectionEnd=n+t.length}e.element.dispatchEvent(new CustomEvent("input",{bubbles:!0})),e.element.dispatchEvent(i)}}pasteHtml(t,e,i){let n,r;r=this.getWindowSelection(),n=this.getDocument().createRange(),n.setStart(r.anchorNode,e),n.setEnd(r.anchorNode,i),n.deleteContents();let o=this.getDocument().createElement("div");o.innerHTML=t;let s,l,u=this.getDocument().createDocumentFragment();for(;s=o.firstChild;)l=u.appendChild(s);n.insertNode(u),l&&(n=n.cloneRange(),n.setStartAfter(l),n.collapse(!0),r.removeAllRanges(),r.addRange(n))}getWindowSelection(){return this.tribute.collection.iframe?this.tribute.collection.iframe.contentWindow.getSelection():window.getSelection()}getNodePositionInParent(t){if(null===t.parentNode)return 0;for(var e=0;e<t.parentNode.childNodes.length;e++){if(t.parentNode.childNodes[e]===t)return e}}getContentEditableSelectedPath(t){let e,i=this.getWindowSelection(),n=i.anchorNode,r=[];if(null!=n){let t,o=n.contentEditable;for(;null!==n&&"true"!==o;)t=this.getNodePositionInParent(n),r.push(t),n=n.parentNode,null!==n&&(o=n.contentEditable);return r.reverse(),e=i.getRangeAt(0).startOffset,{selected:n,path:r,offset:e}}}getTextPrecedingCurrentSelection(){let t=this.tribute.current,e="";if(this.isContentEditable(t.element)){let t=this.getWindowSelection().anchorNode;if(null!=t){let i=t.textContent,n=this.getWindowSelection().getRangeAt(0).startOffset;i&&n>=0&&(e=i.substring(0,n))}}else{let t=this.tribute.current.element;if(t){let i=t.selectionStart;t.value&&i>=0&&(e=t.value.substring(0,i))}}return e}getLastWordInText(t){let e=(t=t.replace(/\u00A0/g," ")).split(/\s+/);return e[e.length-1].trim()}getTriggerInfo(t,e,i,n,r){let o,s,l,u=this.tribute.current;if(this.isContentEditable(u.element)){let t=this.getContentEditableSelectedPath(u);t&&(o=t.selected,s=t.path,l=t.offset)}else o=this.tribute.current.element;let h=this.getTextPrecedingCurrentSelection(),a=this.getLastWordInText(h);if(r)return{mentionPosition:h.length-a.length,mentionText:a,mentionSelectedElement:o,mentionSelectedPath:s,mentionSelectedOffset:l};if(null!=h){let r,u=-1;if(this.tribute.collection.forEach((t=>{let e=t.trigger,n=t.requireLeadingSpace?this.lastIndexWithLeadingSpace(h,e):h.lastIndexOf(e);n>u&&(u=n,r=e,i=t.requireLeadingSpace)})),u>=0&&(0===u||!i||/[\xA0\s]/g.test(h.substring(u-1,u)))){let i=h.substring(u+r.length,h.length);r=h.substring(u,u+r.length);let a=i.substring(0,1),c=i.length>0&&(" "===a||" "===a);e&&(i=i.trim());let d=n?/[^\S ]/g:/[\xA0\s]/g;if(this.tribute.hasTrailingSpace=d.test(i),!c&&(t||!d.test(i)))return{mentionPosition:u,mentionText:i,mentionSelectedElement:o,mentionSelectedPath:s,mentionSelectedOffset:l,mentionTriggerChar:r}}}}lastIndexWithLeadingSpace(t,e){let i=t.split("").reverse().join(""),n=-1;for(let r=0,o=t.length;r<o;r++){let o=r===t.length-1,s=/\s/.test(i[r+1]),l=!0;for(let t=e.length-1;t>=0;t--)if(e[t]!==i[r-t]){l=!1;break}if(l&&(o||s)){n=t.length-1-r;break}}return n}isContentEditable(t){return"INPUT"!==t.nodeName&&"TEXTAREA"!==t.nodeName}isMenuOffScreen(t,e){let i=window.innerWidth,n=window.innerHeight,r=document.documentElement,o=(window.pageXOffset||r.scrollLeft)-(r.clientLeft||0),s=(window.pageYOffset||r.scrollTop)-(r.clientTop||0),l="number"==typeof t.top?t.top:s+n-t.bottom-e.height,u="number"==typeof t.right?t.right:t.left+e.width,h="number"==typeof t.bottom?t.bottom:t.top+e.height,a="number"==typeof t.left?t.left:o+i-t.right-e.width;return{top:l<Math.floor(s),right:u>Math.ceil(o+i),bottom:h>Math.ceil(s+n),left:a<Math.floor(o)}}getMenuDimensions(){let t={width:null,height:null};return this.tribute.menu.style.cssText="top: 0px;\n                                 left: 0px;\n                                 position: fixed;\n                                 display: block;\n                                 visibility; hidden;",t.width=this.tribute.menu.offsetWidth,t.height=this.tribute.menu.offsetHeight,this.tribute.menu.style.cssText="display: none;",t}getTextAreaOrInputUnderlinePosition(t,e,i){let n=null!==window.mozInnerScreenX,r=this.getDocument().createElement("div");r.id="input-textarea-caret-position-mirror-div",this.getDocument().body.appendChild(r);let o=r.style,s=window.getComputedStyle?getComputedStyle(t):t.currentStyle;o.whiteSpace="pre-wrap","INPUT"!==t.nodeName&&(o.wordWrap="break-word"),o.position="absolute",o.visibility="hidden",["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing"].forEach((t=>{o[t]=s[t]})),n?(o.width=parseInt(s.width)-2+"px",t.scrollHeight>parseInt(s.height)&&(o.overflowY="scroll")):o.overflow="hidden",r.textContent=t.value.substring(0,e),"INPUT"===t.nodeName&&(r.textContent=r.textContent.replace(/\s/g," "));let l=this.getDocument().createElement("span");l.textContent=t.value.substring(e)||".",r.appendChild(l);let u=t.getBoundingClientRect(),h=document.documentElement,a=(window.pageXOffset||h.scrollLeft)-(h.clientLeft||0),c=(window.pageYOffset||h.scrollTop)-(h.clientTop||0),d=0,g=0;this.menuContainerIsBody&&(d=u.top,g=u.left);let b={top:d+c+l.offsetTop+parseInt(s.borderTopWidth)+parseInt(s.fontSize)-t.scrollTop,left:g+a+l.offsetLeft+parseInt(s.borderLeftWidth)},m=window.innerWidth,f=window.innerHeight,p=this.getMenuDimensions(),w=this.isMenuOffScreen(b,p);w.right&&(b.right=m-b.left,b.left="auto");let v=this.tribute.menuContainer?this.tribute.menuContainer.offsetHeight:this.getDocument().body.offsetHeight;if(w.bottom){let t=v-(f-(this.tribute.menuContainer?this.tribute.menuContainer.getBoundingClientRect():this.getDocument().body.getBoundingClientRect()).top);b.bottom=t+(f-u.top-l.offsetTop),b.top="auto"}return w=this.isMenuOffScreen(b,p),w.left&&(b.left=m>p.width?a+m-p.width:a,delete b.right),w.top&&(b.top=f>p.height?c+f-p.height:c,delete b.bottom),this.getDocument().body.removeChild(r),b}getContentEditableCaretPosition(t){let e,i=this.getWindowSelection();e=this.getDocument().createRange(),e.setStart(i.anchorNode,t),e.setEnd(i.anchorNode,t),e.collapse(!1);let n=e.getBoundingClientRect(),r=document.documentElement,o=(window.pageXOffset||r.scrollLeft)-(r.clientLeft||0),s=(window.pageYOffset||r.scrollTop)-(r.clientTop||0),l={left:n.left+o,top:n.top+n.height+s},u=window.innerWidth,h=window.innerHeight,a=this.getMenuDimensions(),c=this.isMenuOffScreen(l,a);c.right&&(l.left="auto",l.right=u-n.left-o);let d=this.tribute.menuContainer?this.tribute.menuContainer.offsetHeight:this.getDocument().body.offsetHeight;if(c.bottom){let t=d-(h-(this.tribute.menuContainer?this.tribute.menuContainer.getBoundingClientRect():this.getDocument().body.getBoundingClientRect()).top);l.top="auto",l.bottom=t+(h-n.top)}return c=this.isMenuOffScreen(l,a),c.left&&(l.left=u>a.width?o+u-a.width:o,delete l.right),c.top&&(l.top=h>a.height?s+h-a.height:s,delete l.bottom),this.menuContainerIsBody||(l.left=l.left?l.left-this.tribute.menuContainer.offsetLeft:l.left,l.top=l.top?l.top-this.tribute.menuContainer.offsetTop:l.top),l}scrollIntoView(t){let e,i=this.menu;if(void 0===i)return;for(;void 0===e||0===e.height;)if(e=i.getBoundingClientRect(),0===e.height&&(i=i.childNodes[0],void 0===i||!i.getBoundingClientRect))return;let n=e.top,r=n+e.height;if(n<0)window.scrollTo(0,window.pageYOffset+e.top-20);else if(r>window.innerHeight){let t=window.pageYOffset+e.top-20;t-window.pageYOffset>100&&(t=window.pageYOffset+100);let i=window.pageYOffset-(window.innerHeight-r);i>t&&(i=t),window.scrollTo(0,i)}}}class n{constructor(t){this.tribute=t,this.tribute.search=this}simpleFilter(t,e){return e.filter((e=>this.test(t,e)))}test(t,e){return null!==this.match(t,e)}match(t,e,i){i=i||{},e.length;let n=i.pre||"",r=i.post||"",o=i.caseSensitive&&e||e.toLowerCase();if(i.skip)return{rendered:e,score:0};t=i.caseSensitive&&t||t.toLowerCase();let s=this.traverse(o,t,0,0,[]);return s?{rendered:this.render(e,s.cache,n,r),score:s.score}:null}traverse(t,e,i,n,r){if(e.length===n)return{score:this.calculateScore(r),cache:r.slice()};if(t.length===i||e.length-n>t.length-i)return;let o,s,l=e[n],u=t.indexOf(l,i);for(;u>-1;){if(r.push(u),s=this.traverse(t,e,u+1,n+1,r),r.pop(),!s)return o;(!o||o.score<s.score)&&(o=s),u=t.indexOf(l,u+1)}return o}calculateScore(t){let e=0,i=1;return t.forEach(((n,r)=>{r>0&&(t[r-1]+1===n?i+=i+1:i=1),e+=i})),e}render(t,e,i,n){var r=t.substring(0,e[0]);return e.forEach(((o,s)=>{r+=i+t[o]+n+t.substring(o+1,e[s+1]?e[s+1]:t.length)})),r}filter(t,e,i){return i=i||{},e.reduce(((e,n,r,o)=>{let s=n;i.extract&&(s=i.extract(n),s||(s=""));let l=this.match(t,s,i);return null!=l&&(e[e.length]={string:l.rendered,score:l.score,index:r,original:n}),e}),[]).sort(((t,e)=>{let i=e.score-t.score;return i||t.index-e.index}))}}export{i as T,t as a,e as b,n as c};
