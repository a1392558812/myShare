## **createapp** (è¿”å›ä¸€ä¸ªæä¾›åº”ç”¨ä¸Šä¸‹æ–‡çš„åº”ç”¨å®ä¾‹)

* vue3 main.ts

```ts
import { createApp } from 'vue'
import App from './App.vue'
createApp(App).mount('#app') 
```

* ä¼˜ç‚¹ï¼šæˆ‘æ„¿æ„ç§°ä¹‹ä¸ºéš”ç¦»æ€§ï¼Œvue2çš„ç»„ä»¶ç³»ç»Ÿè®¾è®¡ä¸­ï¼Œæ‰€æœ‰çš„vueå®ä¾‹æ˜¯å…±äº«ä¸€ä¸ªVueæ„é€ å‡½æ•°å¯¹è±¡çš„ï¼ˆåŒ…æ‹¬å…¨å±€æŒ‡ä»¤/å…¨å±€ç»„ä»¶ç­‰ï¼‰ï¼Œæ— æ³•åšåˆ°å®Œå…¨éš”ç¦»

* createappæ¥æ”¶ä¿©ä¸ªå‚æ•°ï¼ˆ**æ ¹ç»„ä»¶é€‰é¡¹**     ï¼Œ      **æ ¹ prop **ï¼‰

* ```ts
  export const createApp = ((...args) => {
    // ensureRenderer().createApp(...args)åˆ›å»ºAppå¯¹è±¡ï¼Œå…¶ä¸­ensureRenderer()æ–¹æ³•å†…éƒ¨è°ƒç”¨createRendereræ–¹æ³•åˆ›å»ºæ¸²æŸ“å™¨ï¼Œ
    // æˆ‘ä»¬åªéœ€çŸ¥é“è¿™ä¸ªå‡½æ•°ä¼šå¸®æˆ‘ä»¬åˆ›å»ºAppå¯¹è±¡
    const app = ensureRenderer().createApp(...args)
     /*
     
      1. è°ƒç”¨ensureRenderer()å‘ç”Ÿäº†ä»€ä¹ˆ,è°ƒç”¨äº†createRenderer
      
      ------------------------ensureRendererå‡½æ•°--------------------------------------------------------------------------------
      
    	-const rendererOptions = {
      -  patchProp,  // å¤„ç† props å±æ€§ 
      -  ...nodeOps // å¤„ç† DOM èŠ‚ç‚¹æ“ä½œ
      -}
      -  // å»¶æ—¶åˆ›å»ºæ¸²æŸ“å™¨ï¼Œå½“ç”¨æˆ·åªä¾èµ–å“åº”å¼åŒ…çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡ tree-shaking ç§»é™¤æ ¸å¿ƒæ¸²æŸ“é€»è¾‘ç›¸å…³çš„ä»£ç 
      -let renderer: Renderer | HydrationRenderer
      -let enabledHydration = false
      -function ensureRenderer() {
      -  return renderer || (renderer = createRenderer(rendererOptions))
      -}
      
      -------------------------------------------------------------------------------------------------------------------------
      
      2. createRendereråšäº†ä»€ä¹ˆï¼Ÿï¼ŸåŒ…è£…è°ƒç”¨baseCreateRenderer
      
      -------------------------------createRendererå‡½æ•°-------------------------------------------------------------------------
      
      - export function createRenderer<
      -   HostNode = RendererNode,
      -   HostElement = RendererElement
      - >(options: RendererOptions<HostNode, HostElement>) {
      -   return baseCreateRenderer<HostNode, HostElement>(options)
      - }
      -------------------------------------------------------------------------------------------------------------------------
     
     3. baseCreateRendereråšäº†ä»€ä¹ˆï¼Œæœ€ç»ˆè¿”å› render hydrate createApp 3ä¸ªå‡½æ•°
     
     --------------------------------------------------baseCreateRendererå‡½æ•°---------------------------------------------------
     
      -function baseCreateRenderer(
      -  options: RendererOptions,
      -  createHydrationFns?: typeof createHydrationFunctions
      -): any {
      -  const {
      -   insert: hostInsert,
      -    remove: hostRemove,
      -    patchProp: hostPatchProp,
      -    createElement: hostCreateElement,
      -    createText: hostCreateText,
      -    createComment: hostCreateComment,
      -    setText: hostSetText,
      -    setElementText: hostSetElementText,
      -    parentNode: hostParentNode,
      -    nextSibling: hostNextSibling,
      -    setScopeId: hostSetScopeId = NOOP,
      -    cloneNode: hostCloneNode,
      -    insertStaticContent: hostInsertStaticContent
      -  } = options
  	-
      -  // ........ä¸€å¤§å †é€»è¾‘
      -  // vnode diff patchå‡åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å®ç°
  	-
      -  return {
      -    render,
      -    hydrate,
      -    // å°†ç”Ÿæˆçš„ render ä¼ ç»™ createAppAPI è¿™ä¸ªçœŸæ­£çš„ createApp æ–¹æ³•
      -    createApp: createAppAPI(render, hydrate) 
      -  }
      - // æˆ‘ä»¬æŠŠæ¡ä½returnå°±è¡Œäº†ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…
      -}
      -------------------------------------------------------------------------------------------------------------------------
      
      4.æŠŠæ¡createAppAPI 
      
      --------------------------createAppAPIå‡½æ•°--------------------------------------------------------------------------------
      
      -    export function createAppAPI<HostElement>(
      -      render: RootRenderFunction,
      -      hydrate?: RootHydrateFunction
      -    ): CreateAppFunction<HostElement> {
      -      return function createApp(rootComponent, rootProps = null) {
      -        if (rootProps != null && !isObject(rootProps)) {
      -          __DEV__ && warn(`root props passed to app.mount() must be an object.`)
      -          rootProps = null
      -        }
      -        // åˆ›å»ºé»˜è®¤APPé…ç½®
      -        const context = createAppContext()
      -        const installedPlugins = new Set()
      -        let isMounted = false
      -        const app: App = {
      -          _component: rootComponent as Component,
      -          _props: rootProps,
      -          _container: null,
      -          _context: context,
      -          get config() {
      -            return context.config
      -          },
      -          set config(v) {
      -            if (__DEV__) {
      -              warn(
      -                `app.config cannot be replaced. Modify individual options instead.`
      -              )
      -            }
      -          },
      -          use() {},
      -          mixin() {},
      -          component() {},
      -          directive() {},
      -          mount() {},
      -          unmount() {},
      -          // .......
      -        }
      -        return app
      -      }
      -    }
      -------------------------------------------------------------------------------------------------------------------------
    */
    // åˆ¤æ–­å½“å‰è¿è¡Œç¯å¢ƒ
    if (__DEV__) {
      injectNativeTagCheck(app)
      /**
        * isHTMLTag æ˜¯å¦æ˜¯htmlæ ‡ç­¾
        * isSVGTag  æ˜¯å¦æ˜¯svgæ ‡ç­¾
        * writable  æ˜¯å¦å¯é‡å†™ï¼Œé»˜è®¤shi
        function injectNativeTagCheck(app: App) {
            // Inject `isNativeTag`
            // this is used for component name validation (dev only)
            // åœ¨å¼€å‘ç¯å¢ƒéªŒè¯ç»„ä»¶åç§°
            // Object.defineProperty()çš„ä½œç”¨å°±æ˜¯ç›´æ¥åœ¨ä¸€ä¸ªå¯¹è±¡ä¸Šå®šä¹‰ä¸€ä¸ªæ–°å±æ€§ï¼Œæˆ–è€…ä¿®æ”¹ä¸€ä¸ªå·²ç»å­˜åœ¨çš„å±æ€§
            Object.defineProperty(app.config, 'isNativeTag', {
              value: (tag: string) => isHTMLTag(tag) || isSVGTag(tag),
              writable: false
            })
          }
      */
      injectCompilerOptionsCheck(app)
      /*
      // dev only
      // æç¤ºç”¨æˆ·ä¸è¦ä½¿ç”¨app.config.compilerOptionsçš„ä¸€äº›é™ˆæ—§å±æ€§
      function injectCompilerOptionsCheck(app: App) {
        if (isRuntimeOnly()) {
        // isRuntimeOnly()åˆ¤æ–­å½“å‰æ˜¯å¦æ˜¯åœ¨ç¼–è¯‘ä¸­
          const isCustomElement = app.config.isCustomElement
          // é‡å†™isCustomElementæ–¹æ³•
          Object.defineProperty(app.config, 'isCustomElement', {
            get() {
              return isCustomElement
            },
            set() {
              warn(
                `The \`isCustomElement\` config option is deprecated. Use ` +
                  `\`compilerOptions.isCustomElement\` instead.`
              )
            }
          })
          const compilerOptions = app.config.compilerOptions
          const msg =
            'åªæœ‰åœ¨ä½¿ç”¨åŒ…å«è¿è¡Œæ—¶ç¼–è¯‘å™¨çš„Vue.jsç‰ˆæœ¬ï¼ˆåˆç§°â€œå®Œæ•´ç‰ˆæœ¬â€ï¼‰æ—¶ï¼Œæ‰è€ƒè™‘â€œCOMPILEROPTIONSâ€é…ç½®é€‰é¡¹' +
           'ç”±äºæ‚¨ä½¿ç”¨çš„æ˜¯ä»…è¿è¡Œæ—¶ç”Ÿæˆï¼Œå› æ­¤å¿…é¡»å°†ï¼ˆcompileoptionsï¼‰ä¼ é€’ç»™ç”Ÿæˆè®¾ç½®ä¸­çš„ï¼ˆ\`@vue/compiler dom\`ï¼‰ã€‚'
            `- For vue-loader: pass it via vue-loader's \`compilerOptions\` loader option.\n` +
            `- For vue-cli: see https://cli.vuejs.org/guide/webpack.html#modifying-options-of-a-loader\n` +
            `- For vite: pass it via @vitejs/plugin-vue options. See https://github.com/vitejs/vite/tree/main/packages/plugin-vue#example-for-passing-options-to-vuecompiler-dom`
  
          Object.defineProperty(app.config, 'compilerOptions', {
            get() {
              warn(msg)
              return compilerOptions
            },
            set() {
              warn(msg)
            }
          })
        }
      }
      */
    }
  
    const { mount } = app
    // é‡å†™mountæ–¹æ³•è¿”å›appå®ä¾‹
    // é‡å†™è¿™ä¸ªæ–¹æ³•çš„åŸå› ä¸»è¦æ˜¯ä¸ºäº†è·¨å¹³å°
    // appå¯¹è±¡çš„mountæ–¹æ³•æ˜¯ä¸€ä¸ªæ ‡å‡†çš„è·¨å¹³å°æ¸²æŸ“æ–¹æ³•(åˆ›å»ºVNode,æ¸²æŸ“VNode)
    // åœ¨Webå¹³å°ä¸‹æ¸²æŸ“åˆçš„VNodeæŒ‚è½½åˆ°Domå¯¹è±¡ä¸Šï¼Œè€Œåœ¨å°ç¨‹åºå…¶ä»–å¹³å°ä¸Šå¯èƒ½è¦æŒ‚è½½åˆ°å…¶ä»–å¯¹è±¡ä¸Š
    app.mount = (containerOrSelector: Element | ShadowRoot | string): any => {
      // è·å–æ ¹èŠ‚ç‚¹ï¼Œ å¦‚æœä¸æ˜¯çœŸå®çš„DOMå…ƒç´ åˆ™ return
      const container = normalizeContainer(containerOrSelector)
      if (!container) return
  	/*
  	 const app: App = (context.app = {
        _uid: uid++,
        _component: rootComponent as ConcreteComponent, // å¥¥åˆ©ç»™ï¼(â—ï¿£(ï½´)ï¿£â—)èƒ¸æ»´ä»¬ï¼Œåœ¨è¿™
        _props: rootProps,
        _container: null,
        _context: context,
        _instance: null,
        version,
        get config() {...}
        set config(v) {...}
        use(plugin: Plugin, ...options: any[]) {....}
        ...
        ...
  
  	*/
      const component = app._component
      //  å¦‚æœcomponentä¸æ˜¯å‡½æ•°ï¼ˆçº¯å‡½æ•°ç»„ä»¶ï¼‰ å¹¶ä¸” æ²¡æœ‰ä¸åŒ…å«renderã€templateï¼ˆemmmmä»–å¥½åƒå°±æ˜¯æ ¹ç»„ä»¶ç½¢äº†ï¼‰
      if (!isFunction(component) && !component.render && !component.template) {
        // ä¸å®‰å…¨çš„æƒ…å†µ
        // åŸå› :å¯èƒ½åœ¨domæ¨¡æ¿ä¸­æ‰§è¡ŒJSè¡¨è¾¾å¼ã€‚
        // ç”¨æˆ·å¿…é¡»ç¡®ä¿å†…domæ¨¡æ¿æ˜¯å¯ä¿¡çš„ã€‚å¦‚æœå®ƒæ˜¯
        // æ¨¡æ¿ä¸åº”è¯¥åŒ…å«ä»»ä½•ç”¨æˆ·æ•°æ®ã€‚
        // ä½¿ç”¨ DOMçš„innerHTMLä½œä¸ºcomponent.template å†…å®¹
        component.template = container.innerHTML
        // 2.xå…¼å®¹æ€§æ£€æŸ¥
        if (__COMPAT__ && __DEV__) {
          // æŒ‚è½½å‰æ£€æŸ¥,ä¾¿åˆ©containerè¿™ä¸ªçœŸå®domçš„æ‰€æœ‰çš„å±æ€§
          for (let i = 0; i < container.attributes.length; i++) {
            const attr = container.attributes[i]
            // /^(v-|:|@)/.test('v-å¥¥åˆ©ç»™') --> true ğŸ‘´??????ğŸ¤”ğŸ¤”ğŸ¤”
            // åœ¨ä¸æ˜¯v-cloakçš„æƒ…å†µä¸‹ï¼Œå°±å•çº¯æµ‹äº†ä¸ª"v-  :     @"
            if (attr.name !== 'v-cloak' && /^(v-|:|@)/.test(attr.name)) {
              compatUtils.warnDeprecation(
                DeprecationTypes.GLOBAL_MOUNT_CONTAINER,
                null
              )
              break
            }
          }
        }
      }
  
      // æ¸…é™¤ä¹‹å‰çš„æŒ‚è½½å†…å®¹
      container.innerHTML = ''
      // instanceof è¿ç®—ç¬¦ç”¨äºæ£€æµ‹æ„é€ å‡½æ•°çš„ prototype å±æ€§æ˜¯å¦å‡ºç°åœ¨æŸä¸ªå®ä¾‹å¯¹è±¡çš„åŸå‹é“¾ä¸Šã€‚
      // appå¯¹è±¡é‡Œé¢åŒ…å«äº†mountæ–¹æ³•ï¼š
      /*
         mount(
          rootContainer: HostElement, // æ ¹dom
          isHydrate?: boolean, // ????emmmè„±æ°´ï¼Ÿæœäº†å¾ˆå¤šï¼Œæ‰¾åˆ°ä¸€ä¸ªé è°±è§£é‡Šæ˜¯SSRæ¸²æŸ“
          isSVG?: boolean
        ): 
      */
      const proxy = mount(container, false, container instanceof SVGElement)
      if (container instanceof Element) {
        container.removeAttribute('v-cloak')
        container.setAttribute('data-v-app', '')
      }
      // å‘è¿”å›ä¸€ä¸ªä»£ç†ï¼Ÿï¼Ÿ
      return proxy
    }
  
    return app
  }) as CreateAppFunction<Element>
  ```
